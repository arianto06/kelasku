<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Manajemen Kelas V B</title>
    <meta name="description" content="Aplikasi Manajemen Kelas untuk Guru">
    <meta name="theme-color" content="#0f766e">
    <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJBcGxpa2FzaSBNYW5hamVtZW4gS2VsYXMiLA0KICAic2hvcnRfbmFtZSI6ICJNYW5hamVtZW4gS2VsYXMiLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YzZjRmNiIsDQogICJ0aGVtZV9jb2xvciI6ICIjMWYyOTM3IiwNCiAgImljb25zIjogWw0KICAgIHsNCiAgICAgICJzcmMiOiAiaHR0cHM6Ly93d3cucG5na2V5LmNvbS9wbmdzL20vMjYtMjY3MzQzX2ljb24tY2xhc3Nyb29tLWljb24tY2xhc3Nyb29tLWljb24tcG5nLXRyYW5zcGFyZW50LnBuZyIsDQogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciDQogICAgfSwNCiAgICB7DQogICAgICAic3JjIjogImh0dHBzOi8vd3d3LnBuZ2tleS5jb20vcG5ncy9tLzI2LTI2NzM0M19pY29uLWNsYXNzcm9vbS1pY29uLWNsYXNzcm9vbS1pY29uLXBuZy10cmFuc3BhcmVudC5wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIg0KICAgIH0NCiAgXQ0KfQ==">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Library untuk handle file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk handle file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Library untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-bg: #134e4a; /* teal-900 */
            --main-bg: #f0fdfa; /* teal-50 */
            --card-bg: #ffffff;
            --primary-color: #0d9488; /* teal-600 */
            --primary-hover: #0f766e; /* teal-700 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --border-color: #e5e7eb; /* gray-200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-primary);
        }
        /* --- Sidebar --- */
        .sidebar {
            background-color: var(--sidebar-bg);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            color: #ccfbf1; /* teal-100 */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }
        .sidebar-link:hover {
            background-color: #115e59; /* teal-800 */
            color: white;
        }
        .sidebar-link.active {
            background-color: var(--primary-color);
            color: white;
            border-left-color: #5eead4; /* teal-300 */
        }
        .sidebar-link i {
            width: 24px;
            margin-right: 12px;
            text-align: center;
        }

        /* --- Main Content --- */
        main {
            background-color: var(--main-bg);
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .dashboard-card-icon {
            padding: 16px;
            border-radius: 12px;
        }

        /* --- Tables --- */
        .table-wrapper {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            overflow-x: auto;
        }
        .table-cell {
            padding: 16px 24px;
            vertical-align: middle;
            white-space: nowrap;
        }
        thead {
            background-color: #f9fafb; /* gray-50 */
        }
        tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        tbody tr:last-child {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #f0fdfa;
        }

        /* --- Buttons & Forms --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
             background-color: #d1d5db;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(13 148 136 / 0.2);
        }

        /* --- Modals --- */
        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .task-completed {
            text-decoration: line-through;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main App Container -->
    <div id="app-container" class="relative min-h-screen md:flex">
        <!-- Mobile menu button -->
        <div class="md:hidden flex justify-between items-center bg-white p-4 shadow-md">
            <div>
                 <h1 class="text-xl font-bold text-gray-800">Manajemen Kelas</h1>
            </div>
            <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-800 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 text-gray-200 grid grid-rows-[auto_1fr_auto] fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-40">
            <div class="p-6 text-center border-b border-teal-800">
                <h1 id="sidebar-title" class="text-2xl font-bold text-white">Manajemen Kelas</h1>
                <p id="sidebar-subtitle" class="text-sm text-teal-200">Kelas V B - Ari Indrianto, S.Pd.</p>
            </div>
            <nav id="sidebar-nav" class="overflow-y-auto px-4 py-4 space-y-1">
                <a href="#" class="sidebar-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                <div class="pt-2 mt-2 border-t border-teal-800/50">
                    <p class="px-4 pt-2 pb-1 text-xs font-semibold text-teal-300 uppercase">Manajemen</p>
                    <a href="#" class="sidebar-link" data-page="siswa"><i class="fas fa-users"></i><span>Data Siswa</span></a>
                    <a href="#" class="sidebar-link" data-page="wali-kelas"><i class="fas fa-user-tie"></i><span>Data Wali Kelas</span></a>
                    <a href="#" class="sidebar-link" data-page="mapel"><i class="fas fa-book-open"></i><span>Mata Pelajaran</span></a>
                    <a href="#" class="sidebar-link" data-page="kategori"><i class="fas fa-tags"></i><span>Kategori Penilaian</span></a>
                    <a href="#" class="sidebar-link" data-page="jadwal"><i class="fas fa-calendar-day"></i><span>Jadwal Pelajaran</span></a>
                </div>
                 <div class="pt-2 mt-2 border-t border-teal-800/50">
                    <p class="px-4 pt-2 pb-1 text-xs font-semibold text-teal-300 uppercase">Aktivitas</p>
                    <a href="#" class="sidebar-link" data-page="tugas-guru"><i class="fas fa-tasks"></i><span>Tugas Guru</span></a>
                    <a href="#" class="sidebar-link" data-page="jurnal-kelas"><i class="fas fa-book-reader"></i><span>Jurnal Kelas</span></a>
                    <a href="#" class="sidebar-link" data-page="catatan-kelas"><i class="fas fa-sticky-note"></i><span>Catatan Kelas</span></a>
                    <a href="#" class="sidebar-link" data-page="input-nilai"><i class="fas fa-edit"></i><span>Input Nilai</span></a>
                    <a href="#" class="sidebar-link" data-page="rekap-nilai"><i class="fas fa-book"></i><span>Rekap Nilai</span></a>
                    <a href="#" class="sidebar-link" data-page="rekap-kehadiran"><i class="fas fa-calendar-alt"></i><span>Rekap Kehadiran</span></a>
                    <a href="#" class="sidebar-link" data-page="rapor-siswa"><i class="fas fa-award"></i><span>Rapor Siswa</span></a>
                </div>
                <div class="pt-2 mt-2 border-t border-teal-800/50">
                     <p class="px-4 pt-2 pb-1 text-xs font-semibold text-teal-300 uppercase">Sistem</p>
                    <a href="#" class="sidebar-link" data-page="data"><i class="fas fa-cogs"></i><span>Pengaturan Data</span></a>
                    <a href="#" class="sidebar-link" data-page="cara-penggunaan"><i class="fas fa-question-circle"></i><span>Cara Penggunaan</span></a>
                    <a href="#" class="sidebar-link" data-page="tentang"><i class="fas fa-info-circle"></i><span>Tentang Aplikasi</span></a>
                </div>
            </nav>
            <div class="p-4 border-t border-teal-800 text-center text-xs text-teal-400">
                <p>Versi 1.8</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-10 overflow-y-auto">
            
            <!-- Page: Dashboard -->
            <div id="page-dashboard">
                <h2 class="text-4xl font-bold text-gray-800">Dashboard</h2>
                <p id="dashboard-date" class="text-lg text-gray-500 mb-8"></p>

                <!-- Attendance Reminder -->
                <div id="attendance-reminder" class="hidden mt-0 mb-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-exclamation-triangle fa-lg mr-4"></i></div>
                        <div>
                            <p class="font-bold">Pengingat Kehadiran</p>
                            <p class="text-sm">Anda belum menginput data kehadiran untuk hari ini. <a href="#" id="link-input-kehadiran" class="font-semibold underline hover:text-yellow-900">Klik di sini untuk menginput sekarang.</a></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
                    <div class="card p-6 flex items-center justify-between">
                        <div>
                            <p class="text-lg text-gray-500">Total Siswa</p>
                            <p id="total-siswa" class="text-5xl font-bold text-blue-500">0</p>
                            <div class="flex space-x-4 mt-1 text-gray-500">
                                <span id="total-laki-laki">L: 0</span>
                                <span id="total-perempuan">P: 0</span>
                            </div>
                        </div>
                        <div class="dashboard-card-icon bg-blue-100 text-blue-500"><i class="fas fa-users text-3xl"></i></div>
                    </div>
                    <div class="card p-6 flex items-center justify-between">
                        <div>
                            <p class="text-lg text-gray-500">Mata Pelajaran</p>
                            <p id="total-mapel" class="text-5xl font-bold text-purple-500">0</p>
                        </div>
                        <div class="dashboard-card-icon bg-purple-100 text-purple-500"><i class="fas fa-book-open text-3xl"></i></div>
                    </div>
                    <div class="card p-6 flex items-center justify-between">
                        <div>
                            <p class="text-lg text-gray-500">Nilai Diinput</p>
                            <p id="total-nilai" class="text-5xl font-bold text-green-500">0</p>
                        </div>
                        <div class="dashboard-card-icon bg-green-100 text-green-500"><i class="fas fa-book text-3xl"></i></div>
                    </div>
                    <div class="card p-6 flex items-center justify-between">
                        <div>
                            <p class="text-lg text-gray-500">Kehadiran Dicatat</p>
                            <p id="total-kehadiran" class="text-5xl font-bold text-yellow-500">0</p>
                        </div>
                        <div class="dashboard-card-icon bg-yellow-100 text-yellow-500"><i class="fas fa-calendar-alt text-3xl"></i></div>
                    </div>
                </div>

                <!-- Dashboard Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-12">
                    <div class="lg:col-span-2 card p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Grafik Kehadiran</h3>
                        <div class="flex items-center space-x-2 mb-4">
                            <input type="date" id="dashboard-attendance-start" class="form-input text-sm p-2">
                            <span class="text-gray-500">-</span>
                            <input type="date" id="dashboard-attendance-end" class="form-input text-sm p-2">
                        </div>
                        <div class="h-80">
                            <canvas id="dashboard-attendance-chart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-3 card p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Rata-Rata Nilai per Mata Pelajaran</h3>
                         <div class="h-96">
                            <canvas id="dashboard-grades-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Jadwal Hari Ini</h3>
                        <div id="jadwal-hari-ini-list" class="space-y-4">
                            <!-- Jadwal hari ini akan dimuat di sini -->
                        </div>
                    </div>
                    <div class="card p-6">
                         <h3 class="text-2xl font-bold text-gray-800 mb-4">Aksi Cepat</h3>
                         <div class="flex space-x-4">
                            <button id="btn-install-app" class="btn btn-primary hidden"><i class="fas fa-download mr-2"></i>Instal Aplikasi</button>
                            <button id="btn-refresh-app" class="btn btn-secondary"><i class="fas fa-sync-alt mr-2"></i>Refresh Aplikasi</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Data Siswa -->
            <div id="page-siswa" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-4xl font-bold text-gray-800">Data Siswa</h2>
                    <div class="flex items-center space-x-3">
                        <button id="btn-download-template" class="btn btn-success"><i class="fas fa-download mr-2"></i>Template</button>
                        <button id="btn-import-excel" class="btn btn-secondary"><i class="fas fa-file-excel mr-2"></i>Import</button>
                        <button id="btn-tambah-siswa" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Siswa</button>
                        <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="table-cell font-semibold text-gray-600 w-16">No.</th>
                                <th class="table-cell font-semibold text-gray-600">NISN</th>
                                <th class="table-cell font-semibold text-gray-600">Nama Lengkap</th>
                                <th class="table-cell font-semibold text-gray-600">Jenis Kelamin</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-siswa"></tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Data Wali Kelas -->
            <div id="page-wali-kelas" class="hidden">
                 <h2 class="text-4xl font-bold text-gray-800 mb-8">Data Wali Kelas</h2>
                <div class="card p-8 max-w-lg mx-auto">
                    <form id="form-wali-kelas">
                        <div class="mb-5">
                            <label for="kelas-nama-input" class="block text-gray-700 mb-2 font-medium">Nama Kelas</label>
                            <input type="text" id="kelas-nama-input" class="form-input" placeholder="Contoh: Kelas V B" required>
                        </div>
                        <div class="mb-8">
                            <label for="wali-nama-input" class="block text-gray-700 mb-2 font-medium">Nama Wali Kelas</label>
                            <input type="text" id="wali-nama-input" class="form-input" placeholder="Contoh: Ari Indrianto, S.Pd." required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Simpan Perubahan</button>
                    </form>
                </div>
            </div>

             <!-- Page: Mata Pelajaran -->
            <div id="page-mapel" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-800">Mata Pelajaran</h2>
                    <button id="btn-tambah-mapel" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah</button>
                </div>
                <div class="table-wrapper">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="table-cell font-semibold text-gray-600">Nama Mata Pelajaran</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-mapel"></tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Kategori Penilaian -->
            <div id="page-kategori" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-800">Kategori Penilaian</h2>
                    <button id="btn-tambah-kategori" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah</button>
                </div>
                <div class="table-wrapper">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="table-cell font-semibold text-gray-600">Nama Kategori</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-kategori"></tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Tugas Guru -->
            <div id="page-tugas-guru" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-4xl font-bold text-gray-800">Daftar Tugas Guru</h2>
                    <button id="btn-tambah-tugas" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Tugas</button>
                </div>
                <div id="tugas-list" class="space-y-4">
                    <!-- Daftar tugas akan dimuat di sini -->
                </div>
            </div>

            <!-- Page: Jurnal Kelas -->
            <div id="page-jurnal-kelas" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-4xl font-bold text-gray-800">Jurnal Mengajar</h2>
                    <button id="btn-tambah-jurnal" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Entri</button>
                </div>
                <div class="card p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="jurnal-filter-tanggal-mulai" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input type="date" id="jurnal-filter-tanggal-mulai" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="jurnal-filter-tanggal-akhir" class="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                            <input type="date" id="jurnal-filter-tanggal-akhir" class="form-input mt-1">
                        </div>
                        <div class="self-end flex space-x-2">
                             <button id="btn-terapkan-filter-jurnal" class="btn btn-primary w-full"><i class="fas fa-filter mr-2"></i>Terapkan</button>
                             <button id="btn-export-jurnal-pdf" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Ekspor</button>
                        </div>
                    </div>
                </div>
                <div id="jurnal-list" class="space-y-6">
                    <!-- Entri jurnal akan dimuat di sini -->
                </div>
            </div>
            
            <!-- Page: Catatan Kelas -->
            <div id="page-catatan-kelas" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Catatan Kelas</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Kolom Catatan Siswa -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Catatan Siswa</h3>
                        <form id="form-catatan-siswa" class="mb-4">
                            <div class="mb-4">
                                <label for="catatan-pilih-siswa" class="block text-gray-700 mb-2 font-medium">Pilih Siswa</label>
                                <select id="catatan-pilih-siswa" class="form-input" required>
                                    <option value="">-- Pilih Siswa --</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="catatan-siswa-input" class="block text-gray-700 mb-2 font-medium">Isi Catatan</label>
                                <textarea id="catatan-siswa-input" rows="4" class="form-input" placeholder="Tulis catatan untuk siswa yang dipilih..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Simpan Catatan Siswa</button>
                        </form>
                        <div class="border-t pt-4">
                            <h4 class="text-lg font-semibold mb-2">Daftar Catatan Siswa:</h4>
                            <div id="catatan-siswa-list" class="space-y-3 max-h-96 overflow-y-auto">
                                <p class="text-center text-gray-500">Pilih seorang siswa untuk melihat catatannya.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Kolom Catatan Umum Kelas -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Catatan Umum Kelas</h3>
                        <form id="form-catatan-kelas" class="mb-4">
                            <div class="mb-4">
                                <label for="catatan-kelas-input" class="block text-gray-700 mb-2 font-medium">Isi Catatan</label>
                                <textarea id="catatan-kelas-input" rows="4" class="form-input" placeholder="Tulis catatan umum untuk seluruh kelas..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Simpan Catatan Kelas</button>
                        </form>
                        <div class="border-t pt-4">
                            <h4 class="text-lg font-semibold mb-2">Daftar Catatan Kelas:</h4>
                            <div id="catatan-kelas-list" class="space-y-3 max-h-96 overflow-y-auto">
                                 <!-- Catatan kelas akan dimuat di sini -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Page: Jadwal Pelajaran -->
            <div id="page-jadwal" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-800">Jadwal Pelajaran</h2>
                     <button id="btn-tambah-jadwal" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah Jadwal</button>
                </div>
                <div class="table-wrapper">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Waktu</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Senin</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Selasa</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Rabu</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Kamis</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Jumat</th>
                                <th class="table-cell border font-semibold text-gray-600 text-center">Sabtu</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-jadwal"></tbody>
                    </table>
                </div>
                <p class="text-sm text-gray-500 mt-4">Klik pada kotak untuk mengubah jadwal, atau gunakan tombol "Tambah Jadwal".</p>
            </div>
            
            <!-- Page: Input Nilai -->
            <div id="page-input-nilai" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Input Nilai</h2>
                <div class="card p-8 max-w-lg mx-auto">
                    <form id="form-input-nilai">
                        <div class="mb-5">
                            <label for="pilih-siswa-nilai" class="block text-gray-700 mb-2 font-medium">Siswa</label>
                            <select id="pilih-siswa-nilai" class="form-input" required></select>
                        </div>
                        <div class="mb-5">
                            <label for="pilih-mapel-nilai" class="block text-gray-700 mb-2 font-medium">Mata Pelajaran</label>
                            <select id="pilih-mapel-nilai" class="form-input" required></select>
                        </div>
                         <div class="mb-5">
                            <label for="pilih-kategori-nilai" class="block text-gray-700 mb-2 font-medium">Kategori Penilaian</label>
                            <select id="pilih-kategori-nilai" class="form-input" required></select>
                        </div>
                        <div class="mb-8">
                            <label for="nilai" class="block text-gray-700 mb-2 font-medium">Nilai</label>
                            <input type="number" id="nilai" min="0" max="100" class="form-input" placeholder="0-100" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Simpan Nilai</button>
                    </form>
                </div>
            </div>

            <!-- Page: Rekap Nilai -->
            <div id="page-rekap-nilai" class="hidden">
                 <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-4xl font-bold text-gray-800">Rekapitulasi Nilai</h2>
                    <button id="btn-export-rekap-nilai" class="btn btn-success"><i class="fas fa-file-excel mr-2"></i>Ekspor Hasil Filter</button>
                </div>
                <div class="card p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2">
                            <label for="filter-nilai-siswa" class="block text-sm font-medium text-gray-700">Nama Siswa</label>
                            <select id="filter-nilai-siswa" class="form-input mt-1"></select>
                        </div>
                        <div>
                            <label for="filter-nilai-mapel" class="block text-sm font-medium text-gray-700">Mata Pelajaran</label>
                            <select id="filter-nilai-mapel" class="form-input mt-1"></select>
                        </div>
                        <div>
                            <label for="filter-nilai-kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                            <select id="filter-nilai-kategori" class="form-input mt-1"></select>
                        </div>
                        <div class="self-end flex space-x-2">
                            <button id="btn-reset-filter-nilai" class="btn btn-secondary w-full"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                </div>
                <div id="grade-chart-container" class="card p-6 mb-8 hidden">
                    <h3 id="grade-chart-title" class="text-xl font-bold text-gray-800 mb-4">Tren Nilai Siswa</h3>
                    <div class="h-80">
                        <canvas id="grade-chart"></canvas>
                    </div>
                </div>
                 <div class="table-wrapper">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="table-cell font-semibold text-gray-600 w-16">No.</th>
                                <th class="table-cell font-semibold text-gray-600">Tanggal</th>
                                <th class="table-cell font-semibold text-gray-600">Nama Siswa</th>
                                <th class="table-cell font-semibold text-gray-600">Mata Pelajaran</th>
                                <th class="table-cell font-semibold text-gray-600">Kategori</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Nilai</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-rekap-nilai"></tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Input Kehadiran -->
            <div id="page-input-kehadiran" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Input Kehadiran</h2>
                <div class="card p-8 max-w-4xl mx-auto">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div>
                            <label for="tanggal-kehadiran" class="block text-gray-700 mb-2 font-medium">Pilih Tanggal</label>
                            <input type="date" id="tanggal-kehadiran" class="form-input" required>
                        </div>
                        <button id="btn-simpan-kehadiran" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Simpan Semua</button>
                    </div>
                    <div class="table-wrapper">
                         <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="table-cell font-semibold text-gray-600 w-16">No.</th>
                                    <th class="table-cell font-semibold text-gray-600">Nama Siswa</th>
                                    <th class="table-cell font-semibold text-gray-600">Status</th>
                                    <th class="table-cell font-semibold text-gray-600">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-input-kehadiran"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Page: Rekap Kehadiran -->
            <div id="page-rekap-kehadiran" class="hidden">
                 <h2 class="text-4xl font-bold text-gray-800 mb-8">Rekapitulasi Kehadiran</h2>
                <div class="card p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="filter-tanggal-mulai" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input type="date" id="filter-tanggal-mulai" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="filter-tanggal-akhir" class="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                            <input type="date" id="filter-tanggal-akhir" class="form-input mt-1">
                        </div>
                        <div class="self-end flex space-x-2">
                             <button id="btn-terapkan-filter-kehadiran" class="btn btn-primary w-full"><i class="fas fa-filter mr-2"></i>Terapkan</button>
                             <button id="btn-export-rekap-kehadiran-excel" class="btn btn-success"><i class="fas fa-file-excel"></i></button>
                             <button id="btn-export-rekap-kehadiran-pdf" class="btn btn-danger"><i class="fas fa-file-pdf"></i></button>
                        </div>
                    </div>
                </div>
                 <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8 text-center">
                    <div class="card p-4">
                        <p class="text-sm text-gray-500">Hadir</p>
                        <p id="rekap-total-hadir" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                     <div class="card p-4">
                        <p class="text-sm text-gray-500">Sakit</p>
                        <p id="rekap-total-sakit" class="text-2xl font-bold text-yellow-600">0</p>
                    </div>
                     <div class="card p-4">
                        <p class="text-sm text-gray-500">Izin</p>
                        <p id="rekap-total-izin" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                     <div class="card p-4">
                        <p class="text-sm text-gray-500">Alpa</p>
                        <p id="rekap-total-alpa" class="text-2xl font-bold text-red-600">0</p>
                    </div>
                     <div class="card p-4 col-span-2 md:col-span-1">
                        <p class="text-sm text-gray-500">Persentase</p>
                        <p id="rekap-persentase" class="text-2xl font-bold text-teal-600">0%</p>
                    </div>
                </div>
                 <div class="table-wrapper">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="table-cell font-semibold text-gray-600 w-16">No.</th>
                                <th class="table-cell font-semibold text-gray-600">Nama Siswa</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Hadir</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Sakit</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Izin</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Alpa</th>
                                <th class="table-cell font-semibold text-gray-600 text-center">Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-rekap-kehadiran"></tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Rapor Siswa -->
            <div id="page-rapor-siswa" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Cetak Rapor Siswa</h2>
                <div class="card p-8 max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="rapor-pilih-siswa" class="block text-gray-700 mb-2 font-medium">Pilih Siswa</label>
                            <select id="rapor-pilih-siswa" class="form-input" required></select>
                        </div>
                        <div>
                             <label for="rapor-periode" class="block text-gray-700 mb-2 font-medium">Periode Laporan</label>
                            <input type="text" id="rapor-periode" class="form-input" placeholder="Contoh: Semester Ganjil 2023/2024">
                        </div>
                        <div>
                            <label for="rapor-tanggal-mulai" class="block text-gray-700 mb-2 font-medium">Dari Tanggal</label>
                            <input type="date" id="rapor-tanggal-mulai" class="form-input" required>
                        </div>
                        <div>
                            <label for="rapor-tanggal-akhir" class="block text-gray-700 mb-2 font-medium">Sampai Tanggal</label>
                            <input type="date" id="rapor-tanggal-akhir" class="form-input" required>
                        </div>
                        <div class="md:col-span-2">
                             <label for="rapor-catatan-guru" class="block text-gray-700 mb-2 font-medium">Catatan Wali Kelas</label>
                            <textarea id="rapor-catatan-guru" rows="4" class="form-input" placeholder="Tulis catatan atau masukan untuk siswa..."></textarea>
                        </div>
                    </div>
                    <button id="btn-buat-rapor" class="btn btn-primary w-full"><i class="fas fa-print mr-2"></i>Buat Rapor PDF</button>
                </div>
            </div>

            <!-- Page: Pengaturan Data -->
            <div id="page-data" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Pengaturan Data</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-8">
                        <h3 class="text-2xl font-bold mb-4">Ekspor Data</h3>
                        <p class="text-gray-600 mb-6">Simpan semua data aplikasi (siswa, nilai, jadwal, dll.) ke dalam satu file cadangan. Simpan file ini di tempat yang aman.</p>
                        <button id="btn-export-data" class="btn btn-success"><i class="fas fa-download mr-2"></i>Ekspor Semua Data</button>
                    </div>
                     <div class="card p-8">
                        <h3 class="text-2xl font-bold mb-4">Impor Data</h3>
                        <p class="text-gray-600 mb-6">Pulihkan data dari file cadangan. <strong class="text-red-600">Peringatan:</strong> Tindakan ini akan menimpa semua data yang ada saat ini.</p>
                        <button id="btn-import-data" class="btn btn-primary"><i class="fas fa-upload mr-2"></i>Impor Data</button>
                        <input type="file" id="import-data-input" class="hidden" accept=".json">
                    </div>
                     <div class="card p-8 border-l-4 border-red-400">
                        <h3 class="text-2xl font-bold mb-4">Reset Aplikasi</h3>
                        <p class="text-gray-600 mb-6">Hapus semua data aplikasi secara permanen. Ini termasuk data siswa, nilai, jadwal, dan semua pengaturan lainnya. Setelah direset, aplikasi akan kembali ke kondisi awal.</p>
                        <button id="btn-reset-app" class="btn btn-danger"><i class="fas fa-exclamation-triangle mr-2"></i>Reset Aplikasi</button>
                    </div>
                </div>
            </div>

            <!-- Page: Cara Penggunaan -->
            <div id="page-cara-penggunaan" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Cara Penggunaan</h2>
                <div class="card p-8 max-w-3xl mx-auto space-y-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-4 text-teal-700">Alur Kerja Aplikasi</h3>
                        <p class="text-gray-600 mb-4">Untuk pengalaman terbaik, ikuti alur kerja yang disarankan berikut ini:</p>
                        <ol class="list-decimal list-inside space-y-2 text-gray-700">
                            <li><strong class="font-semibold">Pengaturan Awal:</strong> Mulailah dengan mengisi data dasar di menu <span class="font-medium text-teal-600">Manajemen</span>. Urutan yang disarankan: Data Wali Kelas, Mata Pelajaran, Kategori Penilaian, lalu Data Siswa.</li>
                            <li><strong class="font-semibold">Aktivitas Harian:</strong> Setelah pengaturan awal selesai, Anda dapat mulai menggunakan menu <span class="font-medium text-teal-600">Aktivitas</span> untuk mencatat Jurnal Kelas, Kehadiran, dan Nilai harian.</li>
                            <li><strong class="font-semibold">Laporan & Utilitas:</strong> Gunakan menu <span class="font-medium text-teal-600">Rekap</span> untuk melihat laporan. Manfaatkan menu <span class="font-medium text-teal-600">Pengaturan Data</span> untuk mencadangkan atau mereset data.</li>
                        </ol>
                    </div>
                    <div class="pt-6 border-t">
                        <h3 class="text-2xl font-bold mb-4 text-teal-700">Tips dan Trik</h3>
                         <ul class="list-disc list-inside text-gray-700 space-y-3">
                            <li><strong class="font-semibold">Instal Aplikasi:</strong> Gunakan tombol <span class="font-medium text-teal-600">"Instal Aplikasi"</span> di Dashboard untuk akses cepat dari desktop atau layar utama ponsel Anda.</li>
                            <li><strong class="font-semibold">Impor Data Siswa:</strong> Untuk memasukkan banyak data siswa sekaligus, unduh template Excel di menu <span class="font-medium text-teal-600">Data Siswa</span>, isi datanya, lalu impor kembali.</li>
                            <li><strong class="font-semibold">Cadangkan Data:</strong> Lakukan ekspor data secara berkala melalui menu <span class="font-medium text-teal-600">Pengaturan Data</span> untuk membuat file cadangan. Ini penting jika Anda berganti perangkat atau browser.</li>
                            <li><strong class="font-semibold">Hati-hati Reset:</strong> Fitur <span class="font-medium text-red-600">Reset Aplikasi</span> akan menghapus semua data secara permanen. Gunakan dengan bijak.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Page: Tentang Aplikasi -->
            <div id="page-tentang" class="hidden">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">Tentang Aplikasi</h2>
                <div class="card p-8 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-center text-teal-700">Aplikasi Manajemen Kelas</h3>
                    <p class="text-center text-gray-600 mb-6">Versi 1.8</p>
                    <p class="text-gray-700 mb-4">
                        Aplikasi ini dirancang untuk membantu para guru dan wali kelas dalam mengelola data akademik dan administratif kelas secara efisien. Semua data disimpan secara lokal di browser Anda, memastikan privasi dan akses offline.
                    </p>
                    <h4 class="text-xl font-bold mt-6 mb-2">Fitur Utama:</h4>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>Manajemen data siswa (termasuk impor dari Excel).</li>
                        <li>Pengelolaan daftar mata pelajaran dan kategori penilaian.</li>
                        <li>Input nilai dan rekapitulasi nilai dengan fitur ekspor ke Excel.</li>
                        <li>Pencatatan dan rekapitulasi kehadiran harian.</li>
                        <li>Jadwal pelajaran mingguan yang interaktif.</li>
                        <li>Personalisasi data wali kelas dan nama kelas.</li>
                        <li>Fitur ekspor dan impor semua data untuk pencadangan.</li>
                        <li>Dapat diinstal di perangkat (PWA) untuk akses seperti aplikasi native.</li>
                    </ul>
                    <div class="mt-8 pt-6 border-t text-center">
                        <p class="text-gray-600">Dibuat dengan ❤️ oleh</p>
                        <p class="text-lg font-semibold text-teal-800 mt-1">Ari I</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal Tambah/Ubah Siswa -->
    <div id="modal-siswa" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 id="modal-siswa-title" class="text-2xl font-bold mb-6">Tambah Siswa Baru</h3>
            <form id="form-siswa">
                <input type="hidden" id="edit-siswa-id">
                <div class="mb-4">
                    <label for="nisn-input" class="block text-gray-700 mb-2 font-medium">NISN</label>
                    <input type="text" id="nisn-input" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="nama-input" class="block text-gray-700 mb-2 font-medium">Nama Lengkap</label>
                    <input type="text" id="nama-input" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="gender-input" class="block text-gray-700 mb-2 font-medium">Jenis Kelamin</label>
                    <select id="gender-input" class="form-input" required>
                        <option value="" disabled selected>-- Pilih Jenis Kelamin --</option>
                        <option value="L">L</option>
                        <option value="P">P</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-siswa" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Ubah Mata Pelajaran -->
    <div id="modal-mapel" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 id="modal-mapel-title" class="text-2xl font-bold mb-6">Tambah Mata Pelajaran</h3>
            <form id="form-mapel">
                <input type="hidden" id="edit-mapel-id">
                <div class="mb-6">
                    <label for="mapel-nama-input" class="block text-gray-700 mb-2 font-medium">Nama Mata Pelajaran</label>
                    <input type="text" id="mapel-nama-input" class="form-input" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-mapel" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Ubah Kategori Penilaian -->
    <div id="modal-kategori" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 id="modal-kategori-title" class="text-2xl font-bold mb-6">Tambah Kategori Penilaian</h3>
            <form id="form-kategori">
                <input type="hidden" id="edit-kategori-id">
                <div class="mb-6">
                    <label for="kategori-nama-input" class="block text-gray-700 mb-2 font-medium">Nama Kategori</label>
                    <input type="text" id="kategori-nama-input" class="form-input" placeholder="Contoh: Ulangan Harian" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-kategori" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Tambah/Ubah Tugas Guru -->
    <div id="modal-tugas" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-lg">
            <h3 id="modal-tugas-title" class="text-2xl font-bold mb-6">Tambah Tugas Baru</h3>
            <form id="form-tugas">
                <input type="hidden" id="edit-tugas-id">
                <div class="mb-4">
                    <label for="tugas-judul-input" class="block text-gray-700 mb-2 font-medium">Judul Tugas</label>
                    <input type="text" id="tugas-judul-input" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="tugas-tanggal-input" class="block text-gray-700 mb-2 font-medium">Jatuh Tempo</label>
                    <input type="date" id="tugas-tanggal-input" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="tugas-deskripsi-input" class="block text-gray-700 mb-2 font-medium">Deskripsi / Catatan</label>
                    <textarea id="tugas-deskripsi-input" rows="4" class="form-input"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-tugas" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Tugas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Ubah Jurnal -->
    <div id="modal-jurnal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-lg">
            <h3 id="modal-jurnal-title" class="text-2xl font-bold mb-6">Entri Jurnal Baru</h3>
            <form id="form-jurnal">
                <input type="hidden" id="edit-jurnal-id">
                <div class="mb-4">
                    <label for="jurnal-tanggal-input" class="block text-gray-700 mb-2 font-medium">Tanggal</label>
                    <input type="date" id="jurnal-tanggal-input" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="jurnal-mapel-select" class="block text-gray-700 mb-2 font-medium">Mata Pelajaran</label>
                    <select id="jurnal-mapel-select" class="form-input" required></select>
                </div>
                <div class="mb-4">
                    <label for="jurnal-materi-input" class="block text-gray-700 mb-2 font-medium">Materi yang Diajarkan</label>
                    <input type="text" id="jurnal-materi-input" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="jurnal-catatan-input" class="block text-gray-700 mb-2 font-medium">Catatan / Keterangan</label>
                    <textarea id="jurnal-catatan-input" rows="4" class="form-input"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-jurnal" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Ubah Nilai -->
    <div id="modal-nilai" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">Ubah Nilai</h3>
            <form id="form-edit-nilai">
                <input type="hidden" id="edit-nilai-id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 font-medium">Siswa</label>
                    <input type="text" id="edit-nilai-siswa-nama" class="form-input bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 font-medium">Mata Pelajaran</label>
                    <input type="text" id="edit-nilai-mapel-nama" class="form-input bg-gray-100" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2 font-medium">Kategori</label>
                    <input type="text" id="edit-nilai-kategori-nama" class="form-input bg-gray-100" readonly>
                </div>
                <div class="mb-6">
                    <label for="edit-nilai-input" class="block text-gray-700 mb-2 font-medium">Nilai</label>
                    <input type="number" id="edit-nilai-input" min="0" max="100" class="form-input" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="btn-batal-edit-nilai" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Jadwal -->
    <div id="modal-jadwal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 id="modal-jadwal-title" class="text-2xl font-bold mb-6">Tambah Jadwal</h3>
            <form id="form-jadwal">
                <input type="hidden" id="jadwal-original-key">
                <div class="mb-4">
                    <label for="jadwal-hari-select" class="block text-gray-700 mb-2 font-medium">Hari</label>
                    <select id="jadwal-hari-select" class="form-input" required></select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="jadwal-waktu-mulai-input" class="block text-gray-700 mb-2 font-medium">Jam Mulai</label>
                        <input type="time" id="jadwal-waktu-mulai-input" class="form-input" required>
                    </div>
                    <div>
                        <label for="jadwal-waktu-selesai-input" class="block text-gray-700 mb-2 font-medium">Jam Selesai</label>
                        <input type="time" id="jadwal-waktu-selesai-input" class="form-input" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="jadwal-mapel-select" class="block text-gray-700 mb-2 font-medium">Mata Pelajaran</label>
                    <select id="jadwal-mapel-select" class="form-input" required></select>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                         <button type="button" id="btn-hapus-jadwal" class="btn btn-danger hidden"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" id="btn-batal-jadwal" class="btn btn-secondary">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="modal-konfirmasi" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="card p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4">Konfirmasi</h3>
            <p id="konfirmasi-pesan" class="text-gray-600 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="btn-konfirmasi-batal" class="btn btn-secondary">Batal</button>
                <button type="button" id="btn-konfirmasi-setuju" class="btn btn-danger">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Konfigurasi ---
            const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            window.jsPDF = window.jspdf.jsPDF;
            let gradeChart = null;
            let dashboardAttendanceChart = null;
            let dashboardGradesChart = null;


            // --- State Management ---
            let state = {
                classInfo: {
                    className: "Kelas V B",
                    teacherName: "Ari Indrianto, S.Pd."
                },
                students: [],
                subjects: [],
                assessmentCategories: [],
                journal: [],
                grades: [],
                attendances: [],
                schedule: {},
                notes: [],
                tasks: [] // <-- New state for teacher tasks
            };

            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const pages = {
                'dashboard': document.getElementById('page-dashboard'),
                'siswa': document.getElementById('page-siswa'),
                'wali-kelas': document.getElementById('page-wali-kelas'),
                'mapel': document.getElementById('page-mapel'),
                'kategori': document.getElementById('page-kategori'),
                'jurnal-kelas': document.getElementById('page-jurnal-kelas'),
                'catatan-kelas': document.getElementById('page-catatan-kelas'),
                'jadwal': document.getElementById('page-jadwal'),
                'input-nilai': document.getElementById('page-input-nilai'),
                'rekap-nilai': document.getElementById('page-rekap-nilai'),
                'input-kehadiran': document.getElementById('page-input-kehadiran'),
                'rekap-kehadiran': document.getElementById('page-rekap-kehadiran'),
                'rapor-siswa': document.getElementById('page-rapor-siswa'),
                'data': document.getElementById('page-data'),
                'tentang': document.getElementById('page-tentang'),
                'cara-penggunaan': document.getElementById('page-cara-penggunaan'),
                'tugas-guru': document.getElementById('page-tugas-guru') // <-- New page element
            };

            const modalSiswa = document.getElementById('modal-siswa');
            const modalMapel = document.getElementById('modal-mapel');
            const modalKategori = document.getElementById('modal-kategori');
            const modalJadwal = document.getElementById('modal-jadwal');
            const modalJurnal = document.getElementById('modal-jurnal');
            const modalNilai = document.getElementById('modal-nilai');
            const modalTugas = document.getElementById('modal-tugas'); // <-- New modal element
            const modalKonfirmasi = document.getElementById('modal-konfirmasi');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const importExcelInput = document.getElementById('import-excel-input');
            const importDataInput = document.getElementById('import-data-input');
            const sidebar = document.getElementById('sidebar');
            const mobileMenuButton = document.getElementById('mobile-menu-button');

            // --- Data Persistence (Local Storage) ---
            const loadState = () => {
                const savedState = JSON.parse(localStorage.getItem('classManagementState'));
                if (savedState) {
                    state.classInfo = savedState.classInfo || { className: "Kelas V B", teacherName: "Ari Indrianto, S.Pd." };
                    state.students = savedState.students || [];
                    state.subjects = savedState.subjects || [];
                    state.assessmentCategories = savedState.assessmentCategories || [];
                    state.journal = savedState.journal || [];
                    state.grades = savedState.grades || [];
                    state.attendances = savedState.attendances || [];
                    state.schedule = savedState.schedule || {};
                    state.notes = savedState.notes || [];
                    state.tasks = savedState.tasks || []; // <-- Load tasks
                }
            };

            const saveState = () => {
                localStorage.setItem('classManagementState', JSON.stringify(state));
            };

            // --- Navigation ---
            const showPage = (pageKey) => {
                const navLinks = document.querySelectorAll('#sidebar-nav .sidebar-link');
                
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageKey]) {
                    pages[pageKey].classList.remove('hidden');
                }

                navLinks.forEach(link => {
                    if (link.dataset.page === pageKey) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                 // Close sidebar on mobile after navigation
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                }
            };

            document.getElementById('sidebar-nav').addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link && link.dataset.page) {
                    e.preventDefault();
                    showPage(link.dataset.page);
                }
            });

            mobileMenuButton.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
            
            // --- Confirmation Modal ---
            const showConfirmationModal = (message, onConfirm) => {
                const confirmMsgEl = document.getElementById('konfirmasi-pesan');
                const confirmBtn = document.getElementById('btn-konfirmasi-setuju');
                const cancelBtn = document.getElementById('btn-konfirmasi-batal');

                confirmMsgEl.textContent = message;
                modalKonfirmasi.classList.remove('hidden');

                const confirmHandler = () => {
                    onConfirm();
                    hideConfirmationModal();
                };
                
                const cancelHandler = () => {
                    hideConfirmationModal();
                };

                const hideConfirmationModal = () => {
                    modalKonfirmasi.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                };

                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', cancelHandler, { once: true });
            };


            // --- Toast Notification ---
            const showToast = (message, isSuccess = true) => {
                toastMessage.textContent = message;
                toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
                toast.classList.remove('opacity-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 4000);
            };

            // --- Rendering Functions ---
            const renderDashboard = () => {
                const maleCount = state.students.filter(s => s.gender === 'L').length;
                const femaleCount = state.students.filter(s => s.gender === 'P').length;

                document.getElementById('total-siswa').textContent = state.students.length;
                document.getElementById('total-laki-laki').textContent = `L: ${maleCount}`;
                document.getElementById('total-perempuan').textContent = `P: ${femaleCount}`;
                document.getElementById('total-mapel').textContent = state.subjects.length;
                document.getElementById('total-nilai').textContent = state.grades.length;
                document.getElementById('total-kehadiran').textContent = state.attendances.length;
                
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('dashboard-date').textContent = today.toLocaleDateString('id-ID', options);

                // Render Jadwal Hari Ini
                const todayDayName = today.toLocaleDateString('id-ID', { weekday: 'long' });
                const jadwalHariIniList = document.getElementById('jadwal-hari-ini-list');
                jadwalHariIniList.innerHTML = '';
                const todaysSchedule = Object.entries(state.schedule)
                    .filter(([key]) => key.startsWith(todayDayName))
                    .sort((a,b) => a[0].localeCompare(b[0])); // Sort by time
                
                if (todaysSchedule.length > 0) {
                    todaysSchedule.forEach(([key, subject]) => {
                        const time = key.split('-')[1] + '-' + key.split('-')[2];
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center p-3 bg-teal-50 rounded-lg';
                        item.innerHTML = `
                            <div>
                                <p class="font-bold text-teal-800">${subject}</p>
                                <p class="text-sm text-gray-500">${time}</p>
                            </div>
                            <i class="fas fa-clock text-teal-400"></i>
                        `;
                        jadwalHariIniList.appendChild(item);
                    });
                } else {
                    jadwalHariIniList.innerHTML = '<p class="text-center text-gray-500">Tidak ada jadwal mengajar hari ini.</p>';
                }
                renderDashboardCharts();
            };
            
            const renderDashboardCharts = () => {
                // Attendance Pie Chart
                const startDate = document.getElementById('dashboard-attendance-start').value;
                const endDate = document.getElementById('dashboard-attendance-end').value;
                const summary = getAttendanceSummary(startDate, endDate);
                
                const totalSummary = Object.values(summary).reduce((acc, curr) => {
                    acc.Hadir += curr.Hadir;
                    acc.Sakit += curr.Sakit;
                    acc.Izin += curr.Izin;
                    acc.Alpa += curr.Alpa;
                    return acc;
                }, { Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0 });

                const attendanceCtx = document.getElementById('dashboard-attendance-chart').getContext('2d');
                if (dashboardAttendanceChart) {
                    dashboardAttendanceChart.destroy();
                }
                dashboardAttendanceChart = new Chart(attendanceCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Hadir', 'Sakit', 'Izin', 'Alpa'],
                        datasets: [{
                            label: 'Kehadiran',
                            data: [totalSummary.Hadir, totalSummary.Sakit, totalSummary.Izin, totalSummary.Alpa],
                            backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });

                // Grades Bar Chart
                const gradesCtx = document.getElementById('dashboard-grades-chart').getContext('2d');
                const subjectAverages = state.subjects.map(subject => {
                    const subjectGrades = state.grades.filter(g => g.subject === subject.name);
                    if (subjectGrades.length === 0) return 0;
                    const total = subjectGrades.reduce((acc, g) => acc + g.grade, 0);
                    return total / subjectGrades.length;
                });
                
                if (dashboardGradesChart) {
                    dashboardGradesChart.destroy();
                }
                dashboardGradesChart = new Chart(gradesCtx, {
                    type: 'bar',
                    data: {
                        labels: state.subjects.map(s => s.name),
                        datasets: [{
                            label: 'Rata-rata Nilai',
                            data: subjectAverages,
                            backgroundColor: 'rgba(13, 148, 136, 0.6)',
                            borderColor: 'rgba(13, 148, 136, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            };

            const checkAndRenderAttendanceReminder = () => {
                const reminderEl = document.getElementById('attendance-reminder');
                if (state.students.length === 0) {
                    reminderEl.classList.add('hidden');
                    return;
                }

                const today = new Date().toISOString().slice(0, 10);
                const attendanceTakenToday = state.attendances.some(att => att.date === today);

                if (attendanceTakenToday) {
                    reminderEl.classList.add('hidden');
                } else {
                    reminderEl.classList.remove('hidden');
                }
            };

            const renderClassInfo = () => {
                document.getElementById('sidebar-subtitle').textContent = `${state.classInfo.className} - ${state.classInfo.teacherName}`;
                document.getElementById('kelas-nama-input').value = state.classInfo.className;
                document.getElementById('wali-nama-input').value = state.classInfo.teacherName;
            };

            const renderStudents = () => {
                const tableBody = document.getElementById('tabel-siswa');
                tableBody.innerHTML = '';
                if (state.students.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center table-cell text-gray-500">Belum ada data siswa.</td></tr>';
                    return;
                }
                state.students.forEach((student, index) => {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell text-gray-700">${index + 1}</td>
                            <td class="table-cell text-gray-700">${student.nisn}</td>
                            <td class="table-cell font-medium text-gray-900">${student.name}</td>
                            <td class="table-cell text-gray-700">${student.gender || 'N/A'}</td>
                            <td class="table-cell text-center">
                                <div class="flex justify-center items-center space-x-2">
                                    <button data-id="${student.id}" class="btn-ubah-siswa text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                    <button data-id="${student.id}" class="btn-hapus-siswa text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            };

            const renderSubjects = () => {
                const tableBody = document.getElementById('tabel-mapel');
                tableBody.innerHTML = '';
                if (state.subjects.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2" class="text-center table-cell text-gray-500">Belum ada data mata pelajaran.</td></tr>';
                    return;
                }
                state.subjects.forEach(subject => {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell font-medium text-gray-900">${subject.name}</td>
                            <td class="table-cell text-center">
                                <div class="flex justify-center items-center space-x-2">
                                    <button data-id="${subject.id}" class="btn-ubah-mapel text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                    <button data-id="${subject.id}" class="btn-hapus-mapel text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            };

            const renderAssessmentCategories = () => {
                const tableBody = document.getElementById('tabel-kategori');
                tableBody.innerHTML = '';
                if (state.assessmentCategories.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2" class="text-center table-cell text-gray-500">Belum ada data kategori penilaian.</td></tr>';
                    return;
                }
                state.assessmentCategories.forEach(category => {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell font-medium text-gray-900">${category.name}</td>
                            <td class="table-cell text-center">
                                <div class="flex justify-center items-center space-x-2">
                                    <button data-id="${category.id}" class="btn-ubah-kategori text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                    <button data-id="${category.id}" class="btn-hapus-kategori text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            };

            const renderJournal = (startDate, endDate) => {
                const listContainer = document.getElementById('jurnal-list');
                listContainer.innerHTML = '';

                let filteredJournal = [...state.journal];

                if (startDate) {
                    filteredJournal = filteredJournal.filter(entry => entry.date >= startDate);
                }
                if (endDate) {
                    filteredJournal = filteredJournal.filter(entry => entry.date <= endDate);
                }

                if (filteredJournal.length === 0) {
                    listContainer.innerHTML = '<div class="card p-8 text-center text-gray-500">Tidak ada entri jurnal pada rentang tanggal yang dipilih.</div>';
                    return;
                }

                const groupedJournal = filteredJournal.reduce((acc, entry) => {
                    const date = entry.date;
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(entry);
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedJournal).sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(date => {
                    const dateHeader = document.createElement('h3');
                    dateHeader.className = "text-2xl font-bold text-gray-700 pb-2 mb-4 border-b-2 border-teal-200";
                    dateHeader.textContent = new Date(date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    listContainer.appendChild(dateHeader);

                    groupedJournal[date].forEach(entry => {
                        const card = document.createElement('div');
                        card.className = "card p-6";
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-xl text-teal-700">${entry.subject}</p>
                                    <h4 class="font-semibold text-lg mt-1">${entry.topic}</h4>
                                    <p class="text-gray-600 mt-2">${entry.notes.replace(/\n/g, '<br>') || '<i>Tidak ada catatan.</i>'}</p>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0 ml-4">
                                    <button data-id="${entry.id}" class="btn-ubah-jurnal text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                    <button data-id="${entry.id}" class="btn-hapus-jurnal text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        listContainer.appendChild(card);
                    });
                });
            };

            const renderTasks = () => {
                const listContainer = document.getElementById('tugas-list');
                listContainer.innerHTML = '';

                if (state.tasks.length === 0) {
                    listContainer.innerHTML = '<div class="card p-8 text-center text-gray-500">Belum ada tugas. Saatnya bersantai!</div>';
                    return;
                }

                const sortedTasks = [...state.tasks].sort((a, b) => a.isCompleted - b.isCompleted || new Date(a.dueDate) - new Date(b.dueDate));

                sortedTasks.forEach(task => {
                    const card = document.createElement('div');
                    const isOverdue = !task.isCompleted && new Date(task.dueDate) < new Date().setHours(0,0,0,0);
                    card.className = `card p-6 flex items-start justify-between ${task.isCompleted ? 'bg-gray-50' : ''}`;
                    card.innerHTML = `
                        <div class="flex items-start">
                            <input type="checkbox" data-id="${task.id}" class="tugas-status-checkbox h-6 w-6 text-teal-600 border-gray-300 rounded focus:ring-teal-500 mt-1 cursor-pointer" ${task.isCompleted ? 'checked' : ''}>
                            <div class="ml-4">
                                <p class="font-bold text-lg ${task.isCompleted ? 'task-completed' : 'text-gray-800'}">${task.title}</p>
                                <p class="text-sm ${isOverdue ? 'text-red-500 font-semibold' : 'text-gray-500'}">
                                    <i class="fas fa-calendar-alt mr-2"></i>Jatuh tempo: ${new Date(task.dueDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}
                                </p>
                                <p class="text-gray-600 mt-2 ${task.isCompleted ? 'task-completed' : ''}">${task.description.replace(/\n/g, '<br>') || '<i>Tidak ada deskripsi.</i>'}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-id="${task.id}" class="btn-ubah-tugas text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                            <button data-id="${task.id}" class="btn-hapus-tugas text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            };
            
            const renderGradeChart = (grades, studentName, subjectName) => {
                const chartContainer = document.getElementById('grade-chart-container');
                const chartTitle = document.getElementById('grade-chart-title');
                const ctx = document.getElementById('grade-chart').getContext('2d');

                if (grades.length < 2) {
                    chartContainer.classList.add('hidden');
                    if (gradeChart) {
                        gradeChart.destroy();
                        gradeChart = null;
                    }
                    return;
                }

                if (gradeChart) {
                    gradeChart.destroy();
                }

                grades.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = grades.map(g => new Date(g.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
                const data = grades.map(g => g.grade);
                
                chartTitle.textContent = `Tren Nilai: ${studentName} - ${subjectName}`;
                chartContainer.classList.remove('hidden');

                gradeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nilai',
                            data: data,
                            borderColor: '#0d9488',
                            backgroundColor: 'rgba(13, 148, 136, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            };

            const renderGrades = () => {
                const tableBody = document.getElementById('tabel-rekap-nilai');
                tableBody.innerHTML = '';
                
                const studentIdFilter = document.getElementById('filter-nilai-siswa').value;
                const subjectFilter = document.getElementById('filter-nilai-mapel').value;
                const categoryFilter = document.getElementById('filter-nilai-kategori').value;

                let filteredGrades = [...state.grades];

                if (studentIdFilter) {
                    filteredGrades = filteredGrades.filter(g => g.studentId === studentIdFilter);
                }
                if (subjectFilter) {
                    filteredGrades = filteredGrades.filter(g => g.subject === subjectFilter);
                }
                if (categoryFilter) {
                    filteredGrades = filteredGrades.filter(g => g.category === categoryFilter);
                }

                 if (filteredGrades.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center table-cell text-gray-500">Tidak ada data nilai yang cocok dengan filter.</td></tr>';
                } else {
                    const sortedGrades = filteredGrades.sort((a,b) => new Date(b.date) - new Date(a.date));
                    sortedGrades.forEach((grade, index) => {
                        const student = state.students.find(s => s.id === grade.studentId);
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="table-cell text-gray-700">${index + 1}</td>
                                <td class="table-cell text-gray-700">${new Date(grade.date).toLocaleDateString('id-ID')}</td>
                                <td class="table-cell font-medium text-gray-900">${student ? student.name : 'Siswa Dihapus'}</td>
                                <td class="table-cell text-gray-700">${grade.subject}</td>
                                <td class="table-cell text-gray-700">${grade.category}</td>
                                <td class="table-cell text-center font-bold ${grade.grade >= 75 ? 'text-green-600' : 'text-red-600'}">${grade.grade}</td>
                                <td class="table-cell text-center">
                                    <div class="flex justify-center items-center space-x-2">
                                        <button data-id="${grade.id}" class="btn-ubah-nilai text-yellow-500 hover:text-yellow-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                        <button data-id="${grade.id}" class="btn-hapus-nilai text-red-500 hover:text-red-700 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }

                // Chart Logic
                if (studentIdFilter && subjectFilter) {
                    const student = state.students.find(s => s.id === studentIdFilter);
                    const chartGrades = filteredGrades.filter(g => g.studentId === studentIdFilter && g.subject === subjectFilter);
                    renderGradeChart(chartGrades, student.name, subjectFilter);
                } else {
                    const chartContainer = document.getElementById('grade-chart-container');
                    chartContainer.classList.add('hidden');
                    if (gradeChart) {
                        gradeChart.destroy();
                        gradeChart = null;
                    }
                }
            };

            const getAttendanceSummary = (startDate, endDate) => {
                let filteredAttendances = state.attendances;
                if (startDate && endDate) {
                    filteredAttendances = state.attendances.filter(att => {
                        return att.date >= startDate && att.date <= endDate;
                    });
                }
                
                const summary = {};
                state.students.forEach(student => {
                    summary[student.id] = {
                        name: student.name,
                        nisn: student.nisn,
                        Hadir: 0,
                        Sakit: 0,
                        Izin: 0,
                        Alpa: 0,
                        total: 0
                    };
                });

                filteredAttendances.forEach(att => {
                    if (summary[att.studentId]) {
                        summary[att.studentId][att.status]++;
                        summary[att.studentId].total++;
                    }
                });
                return summary;
            };

            const renderAttendances = (startDate, endDate) => {
                const tableBody = document.getElementById('tabel-rekap-kehadiran');
                tableBody.innerHTML = '';
                const summary = getAttendanceSummary(startDate, endDate);

                if (state.students.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center table-cell text-gray-500">Tidak ada data siswa.</td></tr>';
                } else {
                     Object.values(summary).forEach((sum, index) => {
                        const percentage = sum.total > 0 ? ((sum.Hadir / sum.total) * 100).toFixed(1) : 0;
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="table-cell text-gray-700">${index + 1}</td>
                                <td class="table-cell font-medium text-gray-900">${sum.name}</td>
                                <td class="table-cell text-center">${sum.Hadir}</td>
                                <td class="table-cell text-center">${sum.Sakit}</td>
                                <td class="table-cell text-center">${sum.Izin}</td>
                                <td class="table-cell text-center">${sum.Alpa}</td>
                                <td class="table-cell text-center font-semibold ${percentage >= 75 ? 'text-green-600' : 'text-red-600'}">${percentage}%</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
                
                // Calculate and render stats
                const totalSummary = Object.values(summary).reduce((acc, curr) => {
                    acc.Hadir += curr.Hadir;
                    acc.Sakit += curr.Sakit;
                    acc.Izin += curr.Izin;
                    acc.Alpa += curr.Alpa;
                    acc.total += curr.total;
                    return acc;
                }, { Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0, total: 0 });

                const overallPercentage = totalSummary.total > 0 ? ((totalSummary.Hadir / totalSummary.total) * 100).toFixed(1) : 0;

                document.getElementById('rekap-total-hadir').textContent = totalSummary.Hadir;
                document.getElementById('rekap-total-sakit').textContent = totalSummary.Sakit;
                document.getElementById('rekap-total-izin').textContent = totalSummary.Izin;
                document.getElementById('rekap-total-alpa').textContent = totalSummary.Alpa;
                document.getElementById('rekap-persentase').textContent = `${overallPercentage}%`;
            };
            
            const renderSchedule = () => {
                const tableBody = document.getElementById('tabel-jadwal');
                tableBody.innerHTML = '';

                const allTimes = [...new Set(Object.keys(state.schedule).map(key => key.split('-')[1] + '-' + key.split('-')[2]))].sort();

                if (allTimes.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${days.length + 1}" class="text-center text-gray-500 table-cell py-10">Jadwal masih kosong. Silakan tambahkan jadwal baru.</td></tr>`;
                    return;
                }

                allTimes.forEach(time => {
                    const row = document.createElement('tr');
                    row.className = 'h-16';

                    const timeCell = document.createElement('td');
                    timeCell.className = 'table-cell border text-center font-mono';
                    timeCell.textContent = time;
                    row.appendChild(timeCell);
                    
                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'table-cell border text-center cursor-pointer';
                        cell.dataset.day = day;
                        cell.dataset.time = time;
                        const key = `${day}-${time}`;
                        const subject = state.schedule[key] || '';
                        cell.textContent = subject;

                        if (subject.toLowerCase().trim() === 'istirahat') {
                            cell.classList.add('bg-gray-100', 'font-semibold', 'text-gray-700');
                        } else if (subject) {
                            cell.classList.add('bg-indigo-50', 'font-medium', 'text-indigo-800');
                        }
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                });
            };

            const populateStudentDropdowns = () => {
                const selects = [
                    document.getElementById('pilih-siswa-nilai'),
                    document.getElementById('catatan-pilih-siswa'),
                    document.getElementById('filter-nilai-siswa'),
                    document.getElementById('rapor-pilih-siswa')
                ];
                
                selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    if (select.id === 'pilih-siswa-nilai' || select.id === 'catatan-pilih-siswa' || select.id === 'rapor-pilih-siswa') {
                        select.innerHTML = `<option value="">-- Pilih Siswa --</option>`;
                    } else {
                        select.innerHTML = `<option value="">-- Semua Siswa --</option>`;
                    }
                    state.students.forEach(student => {
                        const option = `<option value="${student.id}">${student.nisn} - ${student.name}</option>`;
                        select.innerHTML += option;
                    });
                    select.value = currentValue;
                });
            };

            const populateSubjectDropdowns = () => {
                const selects = [
                    document.getElementById('pilih-mapel-nilai'),
                    document.getElementById('jadwal-mapel-select'),
                    document.getElementById('jurnal-mapel-select'),
                    document.getElementById('filter-nilai-mapel')
                ];
                
                selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    if (select.id === 'filter-nilai-mapel') {
                        select.innerHTML = '<option value="">-- Semua Mapel --</option>';
                    } else {
                        select.innerHTML = '<option value="" disabled selected>-- Pilih Mata Pelajaran --</option>';
                    }
                    
                    state.subjects.forEach(subject => {
                        const option = `<option value="${subject.name}">${subject.name}</option>`;
                        select.innerHTML += option;
                    });
                    
                    if (select.id === 'jadwal-mapel-select') {
                        select.innerHTML += '<option value="Istirahat">Istirahat</option>';
                    }
                    select.value = currentValue;
                });
            };

            const populateCategoryDropdowns = () => {
                const selects = [
                    document.getElementById('pilih-kategori-nilai'),
                    document.getElementById('filter-nilai-kategori')
                ];
                
                selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    if (select.id === 'filter-nilai-kategori') {
                        select.innerHTML = '<option value="">-- Semua Kategori --</option>';
                    } else {
                        select.innerHTML = '<option value="" disabled selected>-- Pilih Kategori --</option>';
                    }
                    
                    state.assessmentCategories.forEach(category => {
                        const option = `<option value="${category.name}">${category.name}</option>`;
                        select.innerHTML += option;
                    });
                    select.value = currentValue;
                });
            };

            const renderStudentNotes = (studentId) => {
                const listContainer = document.getElementById('catatan-siswa-list');
                listContainer.innerHTML = '';
                const studentNotes = state.notes
                    .filter(note => note.type === 'student' && note.studentId === studentId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (studentNotes.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">Belum ada catatan untuk siswa ini.</p>';
                    return;
                }

                studentNotes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'bg-blue-50 p-3 rounded-lg flex justify-between items-start';
                    noteEl.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-500">${new Date(note.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                            <p class="text-gray-700">${note.content.replace(/\n/g, '<br>')}</p>
                        </div>
                        <button data-id="${note.id}" class="btn-hapus-catatan text-red-400 hover:text-red-600 p-1 flex-shrink-0 ml-2"><i class="fas fa-times-circle"></i></button>
                    `;
                    listContainer.appendChild(noteEl);
                });
            };

            const renderClassNotes = () => {
                const listContainer = document.getElementById('catatan-kelas-list');
                listContainer.innerHTML = '';
                const classNotes = state.notes
                    .filter(note => note.type === 'class')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (classNotes.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500">Belum ada catatan umum.</p>';
                    return;
                }

                classNotes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = 'bg-green-50 p-3 rounded-lg flex justify-between items-start';
                    noteEl.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-500">${new Date(note.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                            <p class="text-gray-700">${note.content.replace(/\n/g, '<br>')}</p>
                        </div>
                        <button data-id="${note.id}" class="btn-hapus-catatan text-red-400 hover:text-red-600 p-1 flex-shrink-0 ml-2"><i class="fas fa-times-circle"></i></button>
                    `;
                    listContainer.appendChild(noteEl);
                });
            };

            const renderNotesPage = () => {
                populateStudentDropdowns();
                renderClassNotes();
                const selectedStudent = document.getElementById('catatan-pilih-siswa').value;
                if (selectedStudent) {
                    renderStudentNotes(selectedStudent);
                } else {
                     document.getElementById('catatan-siswa-list').innerHTML = '<p class="text-center text-gray-500">Pilih seorang siswa untuk melihat catatannya.</p>';
                }
            };

            const renderAll = () => {
                renderDashboard();
                checkAndRenderAttendanceReminder();
                renderClassInfo();
                renderStudents();
                renderSubjects();
                renderAssessmentCategories();
                renderJournal(
                    document.getElementById('jurnal-filter-tanggal-mulai').value,
                    document.getElementById('jurnal-filter-tanggal-akhir').value
                );
                renderNotesPage();
                renderGrades();
                renderAttendances(
                    document.getElementById('filter-tanggal-mulai').value,
                    document.getElementById('filter-tanggal-akhir').value
                );
                renderSchedule();
                renderTasks();
                populateStudentDropdowns();
                populateSubjectDropdowns();
                populateCategoryDropdowns();
                renderAttendanceInputTable();
            };

            // --- Event Handlers ---

            // Modal Siswa (Tambah & Ubah)
            document.getElementById('btn-tambah-siswa').addEventListener('click', () => {
                document.getElementById('form-siswa').reset();
                document.getElementById('edit-siswa-id').value = '';
                document.getElementById('modal-siswa-title').textContent = 'Tambah Siswa Baru';
                modalSiswa.classList.remove('hidden');
            });

            document.getElementById('tabel-siswa').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-siswa');
                if (editButton) {
                    const studentId = editButton.dataset.id;
                    const student = state.students.find(s => s.id === studentId);
                    if (student) {
                        document.getElementById('edit-siswa-id').value = student.id;
                        document.getElementById('nisn-input').value = student.nisn;
                        document.getElementById('nama-input').value = student.name;
                        document.getElementById('gender-input').value = student.gender;
                        document.getElementById('modal-siswa-title').textContent = 'Ubah Data Siswa';
                        modalSiswa.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('btn-batal-siswa').addEventListener('click', () => {
                modalSiswa.classList.add('hidden');
            });

            document.getElementById('form-siswa').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-siswa-id').value;
                const nisn = document.getElementById('nisn-input').value;
                const name = document.getElementById('nama-input').value;
                const gender = document.getElementById('gender-input').value;
                
                if (id) { // Mode Ubah
                    const studentIndex = state.students.findIndex(s => s.id === id);
                    if (studentIndex > -1) {
                        state.students[studentIndex] = { ...state.students[studentIndex], nisn, name, gender };
                        showToast('Data siswa berhasil diubah!');
                    }
                } else { // Mode Tambah
                    if (state.students.some(s => s.nisn === nisn)) {
                        showToast(`Siswa dengan NISN ${nisn} sudah ada.`, false);
                        return;
                    }
                    const newStudent = { id: Date.now().toString(), nisn, name, gender };
                    state.students.push(newStudent);
                    showToast('Siswa berhasil ditambahkan!');
                }
                
                saveState();
                renderAll();
                modalSiswa.classList.add('hidden');
            });

            // Hapus Siswa
            document.getElementById('tabel-siswa').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-hapus-siswa');
                if (deleteButton) {
                    const studentId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus siswa ini? Menghapus siswa juga akan menghapus semua catatan terkait.', () => {
                        state.students = state.students.filter(s => s.id !== studentId);
                        state.notes = state.notes.filter(n => n.studentId !== studentId);
                        state.grades = state.grades.filter(g => g.studentId !== studentId);
                        state.attendances = state.attendances.filter(a => a.studentId !== studentId);
                        saveState();
                        renderAll();
                        showToast('Siswa berhasil dihapus.');
                    });
                }
            });

            // Form Wali Kelas
            document.getElementById('form-wali-kelas').addEventListener('submit', (e) => {
                e.preventDefault();
                state.classInfo.className = document.getElementById('kelas-nama-input').value.trim();
                state.classInfo.teacherName = document.getElementById('wali-nama-input').value.trim();
                saveState();
                renderClassInfo();
                showToast('Data wali kelas berhasil diperbarui!');
            });

            // Modal Mata Pelajaran (Tambah & Ubah)
            document.getElementById('btn-tambah-mapel').addEventListener('click', () => {
                document.getElementById('form-mapel').reset();
                document.getElementById('edit-mapel-id').value = '';
                document.getElementById('modal-mapel-title').textContent = 'Tambah Mata Pelajaran';
                modalMapel.classList.remove('hidden');
            });
            
            document.getElementById('tabel-mapel').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-mapel');
                if (editButton) {
                    const subjectId = editButton.dataset.id;
                    const subject = state.subjects.find(s => s.id === subjectId);
                    if (subject) {
                        document.getElementById('edit-mapel-id').value = subject.id;
                        document.getElementById('mapel-nama-input').value = subject.name;
                        document.getElementById('modal-mapel-title').textContent = 'Ubah Mata Pelajaran';
                        modalMapel.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('btn-batal-mapel').addEventListener('click', () => {
                modalMapel.classList.add('hidden');
            });

            document.getElementById('form-mapel').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-mapel-id').value;
                const name = document.getElementById('mapel-nama-input').value.trim();
                
                if (id) { // Mode Ubah
                    const subjectIndex = state.subjects.findIndex(s => s.id === id);
                    if (subjectIndex > -1) {
                        state.subjects[subjectIndex].name = name;
                        showToast('Mata pelajaran berhasil diubah!');
                    }
                } else { // Mode Tambah
                    if (state.subjects.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                        showToast(`Mata pelajaran "${name}" sudah ada.`, false);
                        return;
                    }
                    const newSubject = { id: Date.now().toString(), name };
                    state.subjects.push(newSubject);
                    showToast('Mata pelajaran berhasil ditambahkan!');
                }

                saveState();
                renderAll();
                modalMapel.classList.add('hidden');
            });

            // Hapus Mata Pelajaran
            document.getElementById('tabel-mapel').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-hapus-mapel');
                if (deleteButton) {
                    const subjectId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus mata pelajaran ini?', () => {
                        state.subjects = state.subjects.filter(s => s.id !== subjectId);
                        saveState();
                        renderAll();
                        showToast('Mata pelajaran berhasil dihapus.');
                    });
                }
            });

            // Modal Kategori Penilaian (Tambah & Ubah)
            document.getElementById('btn-tambah-kategori').addEventListener('click', () => {
                document.getElementById('form-kategori').reset();
                document.getElementById('edit-kategori-id').value = '';
                document.getElementById('modal-kategori-title').textContent = 'Tambah Kategori Penilaian';
                modalKategori.classList.remove('hidden');
            });

            document.getElementById('tabel-kategori').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-kategori');
                if (editButton) {
                    const categoryId = editButton.dataset.id;
                    const category = state.assessmentCategories.find(c => c.id === categoryId);
                    if (category) {
                        document.getElementById('edit-kategori-id').value = category.id;
                        document.getElementById('kategori-nama-input').value = category.name;
                        document.getElementById('modal-kategori-title').textContent = 'Ubah Kategori Penilaian';
                        modalKategori.classList.remove('hidden');
                    }
                }
            });
            
            document.getElementById('btn-batal-kategori').addEventListener('click', () => {
                modalKategori.classList.add('hidden');
            });

            document.getElementById('form-kategori').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-kategori-id').value;
                const name = document.getElementById('kategori-nama-input').value.trim();
                
                if (id) { // Mode Ubah
                    const categoryIndex = state.assessmentCategories.findIndex(c => c.id === id);
                    if (categoryIndex > -1) {
                        state.assessmentCategories[categoryIndex].name = name;
                        showToast('Kategori berhasil diubah!');
                    }
                } else { // Mode Tambah
                    if (state.assessmentCategories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                        showToast(`Kategori "${name}" sudah ada.`, false);
                        return;
                    }
                    const newCategory = { id: Date.now().toString(), name };
                    state.assessmentCategories.push(newCategory);
                    showToast('Kategori berhasil ditambahkan!');
                }
                
                saveState();
                renderAll();
                modalKategori.classList.add('hidden');
            });

            // Hapus Kategori Penilaian
            document.getElementById('tabel-kategori').addEventListener('click', (e) => {
                 const deleteButton = e.target.closest('.btn-hapus-kategori');
                if (deleteButton) {
                    const categoryId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus kategori ini?', () => {
                        state.assessmentCategories = state.assessmentCategories.filter(c => c.id !== categoryId);
                        saveState();
                        renderAll();
                        showToast('Kategori berhasil dihapus.');
                    });
                }
            });
            
            // Modal Tugas Guru (Tambah & Ubah)
            document.getElementById('btn-tambah-tugas').addEventListener('click', () => {
                document.getElementById('form-tugas').reset();
                document.getElementById('edit-tugas-id').value = '';
                document.getElementById('modal-tugas-title').textContent = 'Tambah Tugas Baru';
                modalTugas.classList.remove('hidden');
            });

            document.getElementById('tugas-list').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-tugas');
                if (editButton) {
                    const taskId = editButton.dataset.id;
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        document.getElementById('edit-tugas-id').value = task.id;
                        document.getElementById('tugas-judul-input').value = task.title;
                        document.getElementById('tugas-tanggal-input').value = task.dueDate;
                        document.getElementById('tugas-deskripsi-input').value = task.description;
                        document.getElementById('modal-tugas-title').textContent = 'Ubah Tugas';
                        modalTugas.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('btn-batal-tugas').addEventListener('click', () => {
                modalTugas.classList.add('hidden');
            });

            document.getElementById('form-tugas').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-tugas-id').value;
                const taskData = {
                    title: document.getElementById('tugas-judul-input').value.trim(),
                    dueDate: document.getElementById('tugas-tanggal-input').value,
                    description: document.getElementById('tugas-deskripsi-input').value.trim(),
                };

                if (id) { // Edit mode
                    const taskIndex = state.tasks.findIndex(t => t.id === id);
                    if (taskIndex > -1) {
                        state.tasks[taskIndex] = { ...state.tasks[taskIndex], ...taskData };
                        showToast('Tugas berhasil diubah!');
                    }
                } else { // Add mode
                    const newTask = { id: Date.now().toString(), ...taskData, isCompleted: false };
                    state.tasks.push(newTask);
                    showToast('Tugas baru berhasil ditambahkan!');
                }

                saveState();
                renderTasks();
                modalTugas.classList.add('hidden');
            });

            document.getElementById('tugas-list').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-hapus-tugas');
                if (deleteButton) {
                    const taskId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus tugas ini?', () => {
                        state.tasks = state.tasks.filter(t => t.id !== taskId);
                        saveState();
                        renderTasks();
                        showToast('Tugas berhasil dihapus.');
                    });
                }

                const statusCheckbox = e.target.closest('.tugas-status-checkbox');
                if (statusCheckbox) {
                    const taskId = statusCheckbox.dataset.id;
                    const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        state.tasks[taskIndex].isCompleted = statusCheckbox.checked;
                        saveState();
                        renderTasks();
                    }
                }
            });

            // Modal Jurnal Kelas (Tambah & Ubah)
            document.getElementById('btn-tambah-jurnal').addEventListener('click', () => {
                document.getElementById('form-jurnal').reset();
                document.getElementById('edit-jurnal-id').value = '';
                document.getElementById('jurnal-tanggal-input').valueAsDate = new Date();
                document.getElementById('modal-jurnal-title').textContent = 'Entri Jurnal Baru';
                modalJurnal.classList.remove('hidden');
            });

            document.getElementById('jurnal-list').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-jurnal');
                if (editButton) {
                    const entryId = editButton.dataset.id;
                    const entry = state.journal.find(j => j.id === entryId);
                    if (entry) {
                        document.getElementById('edit-jurnal-id').value = entry.id;
                        document.getElementById('jurnal-tanggal-input').value = entry.date;
                        document.getElementById('jurnal-mapel-select').value = entry.subject;
                        document.getElementById('jurnal-materi-input').value = entry.topic;
                        document.getElementById('jurnal-catatan-input').value = entry.notes;
                        document.getElementById('modal-jurnal-title').textContent = 'Ubah Entri Jurnal';
                        modalJurnal.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('btn-batal-jurnal').addEventListener('click', () => {
                modalJurnal.classList.add('hidden');
            });

            document.getElementById('form-jurnal').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-jurnal-id').value;
                const newEntryData = {
                    date: document.getElementById('jurnal-tanggal-input').value,
                    subject: document.getElementById('jurnal-mapel-select').value,
                    topic: document.getElementById('jurnal-materi-input').value.trim(),
                    notes: document.getElementById('jurnal-catatan-input').value.trim(),
                };

                if (id) { // Mode Ubah
                    const entryIndex = state.journal.findIndex(j => j.id === id);
                    if (entryIndex > -1) {
                        state.journal[entryIndex] = { ...state.journal[entryIndex], ...newEntryData };
                        showToast('Entri jurnal berhasil diubah!');
                    }
                } else { // Mode Tambah
                    const newEntry = { id: Date.now().toString(), ...newEntryData };
                    state.journal.push(newEntry);
                    showToast('Entri jurnal berhasil disimpan!');
                }
                
                saveState();
                renderAll();
                modalJurnal.classList.add('hidden');
            });

            // Hapus Entri Jurnal
            document.getElementById('jurnal-list').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-hapus-jurnal');
                if (deleteButton) {
                    const entryId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus entri jurnal ini?', () => {
                        state.journal = state.journal.filter(j => j.id !== entryId);
                        saveState();
                        renderAll();
                        showToast('Entri jurnal berhasil dihapus.');
                    });
                }
            });

            // Filter Jurnal
            document.getElementById('btn-terapkan-filter-jurnal').addEventListener('click', () => {
                const startDate = document.getElementById('jurnal-filter-tanggal-mulai').value;
                const endDate = document.getElementById('jurnal-filter-tanggal-akhir').value;
                renderJournal(startDate, endDate);
            });

            // Export Jurnal
            document.getElementById('btn-export-jurnal-pdf').addEventListener('click', () => {
                const startDate = document.getElementById('jurnal-filter-tanggal-mulai').value;
                const endDate = document.getElementById('jurnal-filter-tanggal-akhir').value;
                
                let filteredJournal = [...state.journal];
                if (startDate) filteredJournal = filteredJournal.filter(e => e.date >= startDate);
                if (endDate) filteredJournal = filteredJournal.filter(e => e.date <= endDate);

                if (filteredJournal.length === 0) {
                    showToast('Tidak ada data jurnal untuk diekspor pada rentang ini.', false);
                    return;
                }

                const doc = new jsPDF();
                doc.text(`Laporan Jurnal Mengajar - ${state.classInfo.className}`, 14, 16);
                doc.setFontSize(10);
                doc.text(`Periode: ${startDate ? new Date(startDate).toLocaleDateString('id-ID') : 'Semua'} - ${endDate ? new Date(endDate).toLocaleDateString('id-ID') : 'Semua'}`, 14, 22);
                
                const tableData = filteredJournal.map(entry => [
                    new Date(entry.date).toLocaleDateString('id-ID'),
                    entry.subject,
                    entry.topic,
                    entry.notes || '-'
                ]);

                doc.autoTable({
                    head: [['Tanggal', 'Mata Pelajaran', 'Materi', 'Catatan']],
                    body: tableData,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 148, 136] }
                });

                doc.save(`Laporan_Jurnal_${state.classInfo.className.replace(/\s/g, '_')}.pdf`);
                showToast('Laporan jurnal berhasil diekspor ke PDF!');
            });


            // --- Catatan Kelas Handlers ---
            document.getElementById('form-catatan-siswa').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('catatan-pilih-siswa').value;
                const content = document.getElementById('catatan-siswa-input').value.trim();

                if (!studentId) {
                    showToast('Silakan pilih siswa terlebih dahulu.', false);
                    return;
                }
                if (!content) {
                    showToast('Isi catatan tidak boleh kosong.', false);
                    return;
                }

                const newNote = {
                    id: Date.now().toString(),
                    type: 'student',
                    studentId: studentId,
                    content: content,
                    date: new Date().toISOString()
                };
                state.notes.push(newNote);
                saveState();
                renderStudentNotes(studentId);
                document.getElementById('catatan-siswa-input').value = '';
                showToast('Catatan siswa berhasil disimpan.');
            });

            document.getElementById('form-catatan-kelas').addEventListener('submit', (e) => {
                e.preventDefault();
                const content = document.getElementById('catatan-kelas-input').value.trim();
                
                if (!content) {
                    showToast('Isi catatan tidak boleh kosong.', false);
                    return;
                }

                const newNote = {
                    id: Date.now().toString(),
                    type: 'class',
                    content: content,
                    date: new Date().toISOString()
                };
                state.notes.push(newNote);
                saveState();
                renderClassNotes();
                document.getElementById('catatan-kelas-input').value = '';
                showToast('Catatan kelas berhasil disimpan.');
            });

            document.getElementById('catatan-pilih-siswa').addEventListener('change', (e) => {
                renderStudentNotes(e.target.value);
            });

            document.getElementById('page-catatan-kelas').addEventListener('click', (e) => {
                if (e.target.closest('.btn-hapus-catatan')) {
                    const noteId = e.target.closest('.btn-hapus-catatan').dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus catatan ini?', () => {
                        const noteToDelete = state.notes.find(n => n.id === noteId);
                        state.notes = state.notes.filter(n => n.id !== noteId);
                        saveState();
                        showToast('Catatan berhasil dihapus.');
                        if (noteToDelete.type === 'class') {
                            renderClassNotes();
                        } else {
                            renderStudentNotes(noteToDelete.studentId);
                        }
                    });
                }
            });


            // --- Fitur Excel ---
            document.getElementById('btn-download-template').addEventListener('click', () => {
                const ws_data = [ ["NISN", "Nama Lengkap", "Jenis Kelamin"], ["1001", "Budi Santoso", "L"], ["1002", "Citra Lestari", "P"] ];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "DataSiswa");
                XLSX.writeFile(wb, "template_siswa.xlsx");
            });

            document.getElementById('btn-import-excel').addEventListener('click', () => {
                importExcelInput.click();
            });

            importExcelInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        let importedCount = 0; let skippedCount = 0;

                        jsonData.forEach(item => {
                            const nisn = item.NISN ? String(item.NISN) : null;
                            const name = item['Nama Lengkap'] ? String(item['Nama Lengkap']) : null;
                            const gender = item['Jenis Kelamin'] ? String(item['Jenis Kelamin']) : null;

                            if (nisn && name && gender) {
                                if (!state.students.some(s => s.nisn === nisn)) {
                                    const newStudent = { id: Date.now().toString() + Math.random(), nisn, name, gender };
                                    state.students.push(newStudent);
                                    importedCount++;
                                } else { skippedCount++; }
                            }
                        });

                        if (importedCount > 0) { saveState(); renderAll(); }
                        
                        let message = `${importedCount} siswa berhasil diimpor.`;
                        if (skippedCount > 0) message += ` ${skippedCount} siswa dilewati karena NISN sudah ada.`;
                        showToast(message);

                    } catch (error) {
                        showToast("Gagal memproses file. Pastikan formatnya benar.", false);
                    } finally { e.target.value = ''; }
                };
                reader.readAsArrayBuffer(file);
            });

            document.getElementById('btn-export-rekap-nilai').addEventListener('click', () => {
                const studentIdFilter = document.getElementById('filter-nilai-siswa').value;
                const subjectFilter = document.getElementById('filter-nilai-mapel').value;
                const categoryFilter = document.getElementById('filter-nilai-kategori').value;

                let filteredGrades = [...state.grades];
                if (studentIdFilter) filteredGrades = filteredGrades.filter(g => g.studentId === studentIdFilter);
                if (subjectFilter) filteredGrades = filteredGrades.filter(g => g.subject === subjectFilter);
                if (categoryFilter) filteredGrades = filteredGrades.filter(g => g.category === categoryFilter);


                if (filteredGrades.length === 0) {
                    showToast('Tidak ada data nilai untuk diekspor dengan filter saat ini.', false);
                    return;
                }
                const sortedGrades = filteredGrades.sort((a,b) => new Date(b.date) - new Date(a.date));

                const dataToExport = sortedGrades.map((grade, index) => {
                    const student = state.students.find(s => s.id === grade.studentId);
                    return {
                        'No.': index + 1,
                        'Tanggal': new Date(grade.date).toLocaleDateString('id-ID'),
                        'NISN': student ? student.nisn : 'N/A',
                        'Nama Siswa': student ? student.name : 'Siswa Dihapus',
                        'Mata Pelajaran': grade.subject,
                        'Kategori': grade.category,
                        'Nilai': grade.grade
                    };
                });

                const ws = XLSX.utils.json_to_sheet(dataToExport);

                // Atur lebar kolom
                const colWidths = [
                    { wch: 5 },  // No
                    { wch: 12 }, // Tanggal
                    { wch: 15 }, // NISN
                    { wch: 30 }, // Nama Siswa
                    { wch: 25 }, // Mata Pelajaran
                    { wch: 20 }, // Kategori
                    { wch: 8 }   // Nilai
                ];
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap Nilai");

                XLSX.writeFile(wb, "Rekap_Nilai_Kelas_V_B.xlsx");
                showToast('Rekap nilai berhasil diekspor!');
            });

            // --- Jadwal Pelajaran ---
            const openScheduleModal = (day = '', time = '', subject = '') => {
                document.getElementById('form-jadwal').reset();
                const hariSelect = document.getElementById('jadwal-hari-select');
                const waktuMulaiInput = document.getElementById('jadwal-waktu-mulai-input');
                const waktuSelesaiInput = document.getElementById('jadwal-waktu-selesai-input');
                const mapelSelect = document.getElementById('jadwal-mapel-select');
                const hapusButton = document.getElementById('btn-hapus-jadwal');
                const originalKeyInput = document.getElementById('jadwal-original-key');

                hariSelect.value = day || days[0];
                mapelSelect.value = subject;
                
                if (time) {
                    const [startTime, endTime] = time.split('-');
                    waktuMulaiInput.value = startTime || '';
                    waktuSelesaiInput.value = endTime || '';
                    originalKeyInput.value = `${day}-${time}`;
                } else {
                    originalKeyInput.value = '';
                }

                document.getElementById('modal-jadwal-title').textContent = subject ? 'Ubah Jadwal' : 'Tambah Jadwal';
                
                if (subject) {
                    hapusButton.classList.remove('hidden');
                } else {
                    hapusButton.classList.add('hidden');
                }

                modalJadwal.classList.remove('hidden');
            };

            document.getElementById('btn-tambah-jadwal').addEventListener('click', () => openScheduleModal());
            document.getElementById('btn-batal-jadwal').addEventListener('click', () => modalJadwal.classList.add('hidden'));

            document.getElementById('tabel-jadwal').addEventListener('click', (e) => {
                const cell = e.target.closest('td[data-day]');
                if (cell) {
                    const { day, time } = cell.dataset;
                    const key = `${day}-${time}`;
                    const subject = state.schedule[key] || '';
                    openScheduleModal(day, time, subject);
                }
            });

            document.getElementById('form-jadwal').addEventListener('submit', (e) => {
                e.preventDefault();
                const day = document.getElementById('jadwal-hari-select').value;
                const startTime = document.getElementById('jadwal-waktu-mulai-input').value;
                const endTime = document.getElementById('jadwal-waktu-selesai-input').value;
                const subject = document.getElementById('jadwal-mapel-select').value;
                const originalKey = document.getElementById('jadwal-original-key').value;

                if (!startTime || !endTime) {
                    showToast("Jam mulai dan jam selesai harus diisi.", false);
                    return;
                }
                 if (!subject) {
                    showToast("Mata pelajaran harus dipilih.", false);
                    return;
                }
                
                const newTime = `${startTime}-${endTime}`;
                const newKey = `${day}-${newTime}`;
                
                if (originalKey && originalKey !== newKey) {
                    delete state.schedule[originalKey];
                }

                state.schedule[newKey] = subject;
                
                saveState();
                renderAll();
                modalJadwal.classList.add('hidden');
                showToast('Jadwal berhasil disimpan!');
            });
            
            document.getElementById('btn-hapus-jadwal').addEventListener('click', () => {
                const originalKey = document.getElementById('jadwal-original-key').value;
                
                if (originalKey && originalKey in state.schedule) {
                     showConfirmationModal('Apakah Anda yakin ingin menghapus jadwal ini?', () => {
                        delete state.schedule[originalKey];
                        saveState();
                        renderAll();
                        modalJadwal.classList.add('hidden');
                        showToast('Jadwal berhasil dihapus.');
                    });
                }
            });


            // --- Form Input & Ubah Nilai ---
            document.getElementById('form-input-nilai').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('pilih-siswa-nilai').value;
                const subject = document.getElementById('pilih-mapel-nilai').value;
                const category = document.getElementById('pilih-kategori-nilai').value;
                const grade = parseFloat(document.getElementById('nilai').value);

                if (!studentId || !subject || !category) { 
                    showToast('Semua kolom harus diisi.', false); 
                    return; 
                }

                const newGrade = { id: Date.now().toString(), studentId, subject, category, grade, date: new Date().toISOString() };
                state.grades.push(newGrade);
                saveState();
                renderAll();
                showToast('Nilai berhasil disimpan!');
                e.target.reset();
            });

            document.getElementById('tabel-rekap-nilai').addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-ubah-nilai');
                if (editButton) {
                    const gradeId = editButton.dataset.id;
                    const grade = state.grades.find(g => g.id === gradeId);
                    const student = state.students.find(s => s.id === grade.studentId);
                    if (grade && student) {
                        document.getElementById('edit-nilai-id').value = grade.id;
                        document.getElementById('edit-nilai-siswa-nama').value = student.name;
                        document.getElementById('edit-nilai-mapel-nama').value = grade.subject;
                        document.getElementById('edit-nilai-kategori-nama').value = grade.category;
                        document.getElementById('edit-nilai-input').value = grade.grade;
                        modalNilai.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('btn-batal-edit-nilai').addEventListener('click', () => {
                modalNilai.classList.add('hidden');
            });

            document.getElementById('form-edit-nilai').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-nilai-id').value;
                const newGradeValue = parseFloat(document.getElementById('edit-nilai-input').value);
                const gradeIndex = state.grades.findIndex(g => g.id === id);

                if (gradeIndex > -1) {
                    state.grades[gradeIndex].grade = newGradeValue;
                    state.grades[gradeIndex].date = new Date().toISOString(); // Update timestamp
                    saveState();
                    renderAll();
                    modalNilai.classList.add('hidden');
                    showToast('Nilai berhasil diubah!');
                }
            });

            // Hapus Nilai
            document.getElementById('tabel-rekap-nilai').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.btn-hapus-nilai');
                if (deleteButton) {
                    const gradeId = deleteButton.dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus data nilai ini?', () => {
                        state.grades = state.grades.filter(g => g.id !== gradeId);
                        saveState();
                        renderAll();
                        showToast('Data nilai berhasil dihapus.');
                    });
                }
            });
            
            // --- Filter Rekap Nilai ---
            document.getElementById('filter-nilai-siswa').addEventListener('change', renderGrades);
            document.getElementById('filter-nilai-mapel').addEventListener('change', renderGrades);
            document.getElementById('filter-nilai-kategori').addEventListener('change', renderGrades);
            document.getElementById('btn-reset-filter-nilai').addEventListener('click', () => {
                document.getElementById('filter-nilai-siswa').value = '';
                document.getElementById('filter-nilai-mapel').value = '';
                document.getElementById('filter-nilai-kategori').value = '';
                renderGrades();
            });


            // --- Form Input Kehadiran ---
            document.getElementById('btn-simpan-kehadiran').addEventListener('click', () => {
                const date = document.getElementById('tanggal-kehadiran').value;
                if (!date) {
                    showToast('Silakan pilih tanggal terlebih dahulu.', false);
                    return;
                }

                const attendanceRows = document.querySelectorAll('#tabel-input-kehadiran tr');
                let entriesAdded = 0;
                attendanceRows.forEach((row, index) => {
                    const studentId = row.dataset.studentId;
                    if (studentId) {
                        const selectedStatus = row.querySelector(`select[name="status-${studentId}"]`).value;
                        const notes = row.querySelector(`input[name="notes-${studentId}"]`).value;
                        
                        const newAttendance = {
                            id: Date.now().toString() + studentId,
                            studentId: studentId,
                            date: date,
                            status: selectedStatus,
                            notes: notes
                        };
                        // Hapus entri lama untuk siswa dan tanggal yang sama untuk menghindari duplikat
                        state.attendances = state.attendances.filter(att => !(att.studentId === studentId && att.date === date));
                        state.attendances.push(newAttendance);
                        entriesAdded++;
                    }
                });

                if (entriesAdded > 0) {
                    saveState();
                    renderAll();
                    showToast(`${entriesAdded} data kehadiran berhasil disimpan!`);
                } else {
                    showToast('Tidak ada data kehadiran untuk disimpan.', false);
                }
            });
            
             // Hapus Kehadiran
            document.getElementById('tabel-rekap-kehadiran').addEventListener('click', (e) => {
                if (e.target.closest('.btn-hapus-kehadiran')) {
                    const attId = e.target.closest('.btn-hapus-kehadiran').dataset.id;
                    showConfirmationModal('Apakah Anda yakin ingin menghapus data kehadiran ini?', () => {
                        state.attendances = state.attendances.filter(a => a.id !== attId);
                        saveState();
                        renderAll();
                        showToast('Data kehadiran berhasil dihapus.');
                    });
                }
            });

            const renderAttendanceInputTable = () => {
                const tableBody = document.getElementById('tabel-input-kehadiran');
                tableBody.innerHTML = '';
                if (state.students.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center table-cell text-gray-500">Silakan tambah data siswa terlebih dahulu.</td></tr>';
                    return;
                }
                state.students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.dataset.studentId = student.id;
                    row.innerHTML = `
                        <td class="table-cell text-gray-700">${index + 1}</td>
                        <td class="table-cell font-medium text-gray-900">${student.name}</td>
                        <td class="table-cell">
                            <select name="status-${student.id}" class="form-input attendance-status-select" data-student-id="${student.id}">
                                <option value="Hadir" selected>Hadir</option>
                                <option value="Sakit">Sakit</option>
                                <option value="Izin">Izin</option>
                                <option value="Alpa">Alpa</option>
                            </select>
                        </td>
                        <td class="table-cell">
                            <input type="text" name="notes-${student.id}" class="form-input attendance-notes-input hidden" placeholder="Keterangan...">
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            };

            document.getElementById('tabel-input-kehadiran').addEventListener('change', (e) => {
                if (e.target.classList.contains('attendance-status-select')) {
                    const studentId = e.target.dataset.studentId;
                    const notesInput = document.querySelector(`input[name="notes-${studentId}"]`);
                    if (e.target.value === 'Sakit' || e.target.value === 'Izin') {
                        notesInput.classList.remove('hidden');
                    } else {
                        notesInput.classList.add('hidden');
                        notesInput.value = '';
                    }
                }
            });

            document.getElementById('btn-terapkan-filter-kehadiran').addEventListener('click', () => {
                const startDate = document.getElementById('filter-tanggal-mulai').value;
                const endDate = document.getElementById('filter-tanggal-akhir').value;
                renderAttendances(startDate, endDate);
            });
            
            document.getElementById('btn-export-rekap-kehadiran-excel').addEventListener('click', () => {
                const startDate = document.getElementById('filter-tanggal-mulai').value;
                const endDate = document.getElementById('filter-tanggal-akhir').value;
                const summary = getAttendanceSummary(startDate, endDate);

                if (Object.keys(summary).length === 0) {
                    showToast('Tidak ada data untuk diekspor.', false);
                    return;
                }

                const dataToExport = Object.values(summary).map((s, index) => {
                    const percentage = s.total > 0 ? ((s.Hadir / s.total) * 100).toFixed(1) + '%' : '0%';
                    return {
                        'No.': index + 1,
                        'Nama Siswa': s.name,
                        'Hadir': s.Hadir,
                        'Sakit': s.Sakit,
                        'Izin': s.Izin,
                        'Alpa': s.Alpa,
                        'Kehadiran': percentage
                    };
                });

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                ws['!cols'] = [{wch:5}, {wch:30},{wch:10},{wch:10},{wch:10},{wch:10},{wch:15}];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap Kehadiran");
                XLSX.writeFile(wb, `Rekap_Kehadiran_${state.classInfo.className.replace(/\s/g, '_')}.xlsx`);
                showToast('Rekap kehadiran berhasil diekspor ke Excel!');
            });

            document.getElementById('btn-export-rekap-kehadiran-pdf').addEventListener('click', () => {
                const startDate = document.getElementById('filter-tanggal-mulai').value;
                const endDate = document.getElementById('filter-tanggal-akhir').value;
                const summary = getAttendanceSummary(startDate, endDate);

                if (Object.keys(summary).length === 0) {
                    showToast('Tidak ada data untuk diekspor.', false);
                    return;
                }

                const doc = new jsPDF();
                doc.text(`Rekapitulasi Kehadiran - ${state.classInfo.className}`, 14, 16);
                doc.setFontSize(10);
                doc.text(`Periode: ${startDate ? new Date(startDate).toLocaleDateString('id-ID') : 'Semua'} - ${endDate ? new Date(endDate).toLocaleDateString('id-ID') : 'Semua'}`, 14, 22);

                const tableColumn = ["No.", "Nama Siswa", "Hadir", "Sakit", "Izin", "Alpa", "Persentase"];
                const tableRows = [];

                Object.values(summary).forEach((sum, index) => {
                    const percentage = sum.total > 0 ? ((sum.Hadir / sum.total) * 100).toFixed(1) + '%' : '0%';
                    const rowData = [
                        index + 1,
                        sum.name,
                        sum.Hadir,
                        sum.Sakit,
                        sum.Izin,
                        sum.Alpa,
                        percentage
                    ];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 148, 136] }
                });
                
                doc.save(`Rekap_Kehadiran_${state.classInfo.className.replace(/\s/g, '_')}.pdf`);
                showToast('Rekap kehadiran berhasil diekspor ke PDF!');
            });
            
            // --- Rapor Siswa Handler ---
            document.getElementById('btn-buat-rapor').addEventListener('click', () => {
                const studentId = document.getElementById('rapor-pilih-siswa').value;
                const startDate = document.getElementById('rapor-tanggal-mulai').value;
                const endDate = document.getElementById('rapor-tanggal-akhir').value;
                const periode = document.getElementById('rapor-periode').value.trim();
                const teacherNotes = document.getElementById('rapor-catatan-guru').value.trim();

                if (!studentId || !startDate || !endDate || !periode) {
                    showToast('Harap lengkapi semua kolom: Siswa, Periode, dan rentang tanggal.', false);
                    return;
                }

                const student = state.students.find(s => s.id === studentId);
                if (!student) {
                    showToast('Siswa tidak ditemukan.', false);
                    return;
                }

                // 1. Kumpulkan dan proses nilai
                const studentGrades = state.grades.filter(g => g.studentId === studentId && g.date >= startDate && g.date <= endDate);
                const gradesBySubject = studentGrades.reduce((acc, grade) => {
                    if (!acc[grade.subject]) {
                        acc[grade.subject] = [];
                    }
                    acc[grade.subject].push(grade.grade);
                    return acc;
                }, {});

                const finalGrades = Object.keys(gradesBySubject).map((subject, index) => {
                    const grades = gradesBySubject[subject];
                    const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                    let predicate = 'D';
                    if (average >= 85) predicate = 'A';
                    else if (average >= 75) predicate = 'B';
                    else if (average >= 65) predicate = 'C';
                    return [index + 1, subject, average.toFixed(2), predicate];
                });

                // 2. Kumpulkan rekap kehadiran
                const attendanceSummary = getAttendanceSummary(startDate, endDate)[studentId];

                // 3. Buat PDF
                const doc = new jsPDF();
                const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

                // Header
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('LAPORAN HASIL BELAJAR (RAPOR)', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                
                // Student Info
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Nama Siswa\t: ${student.name}`, 14, 35);
                doc.text(`NISN\t\t: ${student.nisn}`, 14, 42);
                doc.text(`Kelas\t\t: ${state.classInfo.className}`, 14, 49);
                doc.text(`Periode\t\t: ${periode}`, 14, 56);
                
                // Grades Table
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('A. Nilai Akademik', 14, 70);
                doc.autoTable({
                    startY: 75,
                    head: [['No.', 'Mata Pelajaran', 'Nilai Akhir', 'Predikat']],
                    body: finalGrades,
                    theme: 'grid',
                    headStyles: { fillColor: [13, 148, 136] }
                });

                let lastY = doc.lastAutoTable.finalY;

                // Attendance
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('B. Ketidakhadiran', 14, lastY + 15);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Sakit: ${attendanceSummary.Sakit} hari`, 20, lastY + 22);
                doc.text(`Izin: ${attendanceSummary.Izin} hari`, 20, lastY + 29);
                doc.text(`Tanpa Keterangan: ${attendanceSummary.Alpa} hari`, 20, lastY + 36);

                // Teacher Notes
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('C. Catatan Wali Kelas', 14, lastY + 50);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(doc.splitTextToSize(teacherNotes || 'Tidak ada catatan.', 180), 14, lastY + 57);

                // Signatures
                doc.text(`Surabaya, ${today}`, 130, lastY + 90);
                doc.text('Orang Tua/Wali,', 20, lastY + 100);
                doc.text('Wali Kelas,', 130, lastY + 100);
                doc.text('(___________________)', 20, lastY + 125);
                doc.text(`( ${state.classInfo.teacherName} )`, 130, lastY + 125);

                doc.save(`Rapor_${student.name.replace(/\s/g, '_')}_${state.classInfo.className.replace(/\s/g, '_')}.pdf`);
                showToast('Rapor siswa berhasil dibuat!');
            });


            // --- Pengaturan Data & Backup ---
            const exportData = (isAuto = false) => {
                const dataStr = JSON.stringify(state, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const today = new Date().toISOString().slice(0, 10);
                
                if (isAuto) {
                    link.download = `cadangan-otomatis-manajemen-kelas-${today}.json`;
                    showToast('Auto-backup harian berhasil dilakukan.');
                } else {
                    link.download = `cadangan-manual-manajemen-kelas-${today}.json`;
                    showToast('Data berhasil diekspor!');
                }

                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const autoBackup = () => {
                const today = new Date().toISOString().slice(0, 10);
                const lastBackupDate = localStorage.getItem('lastBackupDate');
                // Don't backup if there's no data yet
                if (state.students.length === 0 && state.grades.length === 0 && state.attendances.length === 0) {
                    return;
                }
                if (lastBackupDate !== today) {
                    exportData(true);
                    localStorage.setItem('lastBackupDate', today);
                }
            };

            document.getElementById('btn-export-data').addEventListener('click', () => exportData(false));

            document.getElementById('btn-import-data').addEventListener('click', () => {
                importDataInput.click();
            });

            importDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showConfirmationModal('Apakah Anda yakin ingin mengimpor data? Tindakan ini akan menimpa semua data yang ada saat ini.', () => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            // Validasi sederhana
                            if (importedState.students && importedState.subjects) {
                                state = importedState;
                                saveState();
                                renderAll();
                                showToast('Data berhasil diimpor!');
                            } else {
                                showToast('File cadangan tidak valid.', false);
                            }
                        } catch (error) {
                            showToast('Gagal membaca file. Pastikan file cadangan benar.', false);
                        } finally {
                            e.target.value = '';
                        }
                    };
                    reader.readAsText(file);
                });
                
                // Reset file input in case user cancels
                e.target.value = '';
            });
            
            document.getElementById('btn-reset-app').addEventListener('click', () => {
                showConfirmationModal('PERINGATAN!\n\nAnda yakin ingin mereset seluruh aplikasi? Semua data siswa, nilai, dan jadwal akan hilang permanen. Tindakan ini tidak dapat diurungkan.', () => {
                    localStorage.clear();
                    location.reload();
                });
            });

            // --- Fitur PWA dan Refresh ---
            document.getElementById('btn-refresh-app').addEventListener('click', () => {
                location.reload();
            });

            document.getElementById('link-input-kehadiran').addEventListener('click', (e) => {
                e.preventDefault();
                showPage('input-kehadiran');
            });

            let deferredPrompt;
            const installButton = document.getElementById('btn-install-app');

            window.addEventListener('beforeinstallprompt', (e) => {
                // Mencegah browser menampilkan prompt default
                e.preventDefault();
                // Menyimpan event agar bisa dipicu nanti.
                deferredPrompt = e;
                // Menampilkan tombol instalasi
                installButton.classList.remove('hidden');
            });

            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    // Menampilkan prompt instalasi
                    deferredPrompt.prompt();
                    // Menunggu hasil pilihan pengguna
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    // Prompt hanya bisa digunakan sekali, jadi kita reset
                    deferredPrompt = null;
                    // Sembunyikan tombol setelah digunakan
                    installButton.classList.add('hidden');
                }
            });

            // Dashboard Chart Filters
            document.getElementById('dashboard-attendance-start').addEventListener('change', renderDashboardCharts);
            document.getElementById('dashboard-attendance-end').addEventListener('change', renderDashboardCharts);


            // --- Initial Load ---
            const initApp = () => {
                const hariSelect = document.getElementById('jadwal-hari-select');
                hariSelect.innerHTML = '';
                days.forEach(d => hariSelect.innerHTML += `<option value="${d}">${d}</option>`);

                loadState();
                autoBackup(); // Jalankan auto-backup saat aplikasi dimulai
                renderAll();
                showPage('dashboard');
                document.getElementById('tanggal-kehadiran').valueAsDate = new Date();
                appContainer.classList.remove('hidden');
            };
            
            initApp();
        });
    </script>
</body>
</html>
